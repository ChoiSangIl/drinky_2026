# Story 2.1: 기록 차트 - 캘린더 뷰

## Status

**Draft**

---

## Story

**As a** 사용자,
**I want** 월간 캘린더에서 내 음주 기록을 한눈에 볼 수 있어서,
**so that** 어떤 날에 술을 마셨는지 패턴을 파악할 수 있다.

---

## Acceptance Criteria

1. 기록 탭/페이지 생성 및 네비게이션 연결
2. 월간 캘린더 뷰 구현 (현재 월 기본 표시)
3. 각 날짜에 O/X 아이콘 또는 색상으로 음주 여부 표시
4. 이전/다음 월 네비게이션
5. 기록 없는 날은 빈 상태로 표시
6. 특정 날짜 클릭 시 해당 날짜 상세 정보 표시 (모달 또는 바텀시트)
7. 모바일 반응형 UI

---

## Tasks / Subtasks

- [ ] **Task 1: 기록 페이지 라우팅** (AC: 1)
  - [ ] `CalendarController.kt` 생성
  - [ ] `GET /calendar` - 캘린더 페이지 렌더링
  - [ ] `GET /calendar/{year}/{month}` - 특정 월 데이터 (HTMX용)

- [ ] **Task 2: 하단 네비게이션 활성화** (AC: 1)
  - [ ] `bottom-nav.html` 수정
  - [ ] 기록 탭 활성화 (링크 연결)
  - [ ] 현재 페이지에 따른 활성 상태 표시

- [ ] **Task 3: 캘린더 데이터 조회** (AC: 2, 3, 5)
  - [ ] `CheckInService` 확장
    - [ ] `getMonthlyCheckIns(userId: UUID, year: Int, month: Int): Map<LocalDate, CheckIn>`
  - [ ] 월별 체크인 데이터 조회
  - [ ] 날짜별 Map으로 변환

- [ ] **Task 4: 월간 캘린더 UI** (AC: 2, 3, 5, 7)
  - [ ] `templates/pages/calendar.html` 생성
  - [ ] 캘린더 그리드 레이아웃 (7열 x 5-6행)
  - [ ] 요일 헤더 (일, 월, 화, 수, 목, 금, 토)
  - [ ] 날짜 셀 스타일링
    - [ ] ⭕ 금주: 초록색 배경/테두리
    - [ ] ❌ 음주: 회색/주황색 배경
    - [ ] 기록 없음: 빈 상태
    - [ ] 오늘: 강조 테두리
    - [ ] 미래 날짜: 비활성화

- [ ] **Task 5: 월 네비게이션** (AC: 4)
  - [ ] 이전/다음 월 버튼
  - [ ] HTMX로 월 변경 시 캘린더 업데이트
    ```html
    hx-get="/calendar/2026/2"
    hx-target="#calendar-grid"
    hx-swap="innerHTML"
    ```
  - [ ] 현재 년월 표시 ("2026년 1월")

- [ ] **Task 6: 날짜 상세 바텀시트** (AC: 6)
  - [ ] `templates/fragments/day-detail.html` 생성
  - [ ] 날짜 클릭 시 바텀시트 표시 (Alpine.js)
  - [ ] 표시 내용:
    - [ ] 날짜
    - [ ] 체크인 상태 (⭕/❌)
    - [ ] 메모 (있는 경우)
    - [ ] 수정 버튼 (Story 2.3에서 구현)

- [ ] **Task 7: 반응형 최적화** (AC: 7)
  - [ ] 모바일 캘린더 셀 크기 조정
  - [ ] 터치 영역 44x44px 이상
  - [ ] 스와이프로 월 변경 (선택사항)

---

## Dev Notes

### 프로젝트 구조 (이 스토리 관련)

```
src/main/kotlin/com/drinky/
├── controller/
│   └── CalendarController.kt
├── service/
│   └── CheckInService.kt (확장)
└── domain/
    └── dto/
        └── CalendarDayDto.kt

src/main/resources/templates/
├── pages/
│   └── calendar.html
└── fragments/
    ├── calendar-grid.html
    └── day-detail.html
```

### CalendarController 예시

```kotlin
@Controller
@RequestMapping("/calendar")
class CalendarController(
    private val checkInService: CheckInService
) {
    @GetMapping
    fun calendarPage(
        @AuthenticationPrincipal principal: UserPrincipal,
        model: Model
    ): String {
        val now = LocalDate.now()
        addCalendarData(model, principal.userId, now.year, now.monthValue)
        return "pages/calendar"
    }

    @GetMapping("/{year}/{month}")
    fun getMonthCalendar(
        @AuthenticationPrincipal principal: UserPrincipal,
        @PathVariable year: Int,
        @PathVariable month: Int,
        model: Model
    ): String {
        addCalendarData(model, principal.userId, year, month)
        return "fragments/calendar-grid"
    }

    private fun addCalendarData(model: Model, userId: UUID, year: Int, month: Int) {
        val checkIns = checkInService.getMonthlyCheckIns(userId, year, month)
        val calendarDays = buildCalendarDays(year, month, checkIns)

        model.addAttribute("year", year)
        model.addAttribute("month", month)
        model.addAttribute("calendarDays", calendarDays)
        model.addAttribute("prevMonth", YearMonth.of(year, month).minusMonths(1))
        model.addAttribute("nextMonth", YearMonth.of(year, month).plusMonths(1))
    }
}
```

### CalendarDayDto

```kotlin
data class CalendarDayDto(
    val date: LocalDate,
    val dayOfMonth: Int,
    val isCurrentMonth: Boolean,
    val isToday: Boolean,
    val isFuture: Boolean,
    val checkIn: CheckIn? = null
) {
    val isSober: Boolean? get() = checkIn?.isSober
    val hasRecord: Boolean get() = checkIn != null
}
```

### 캘린더 그리드 UI 예시

```html
<div th:fragment="grid" id="calendar-grid">
    <!-- 월 네비게이션 -->
    <div class="flex items-center justify-between mb-4">
        <button hx-get="@{/calendar/{year}/{month}(year=${prevMonth.year}, month=${prevMonth.monthValue})}"
                hx-target="#calendar-grid"
                class="p-2 hover:bg-gray-100 rounded-full">
            ←
        </button>
        <h2 class="text-lg font-semibold" th:text="${year + '년 ' + month + '월'}">2026년 1월</h2>
        <button hx-get="@{/calendar/{year}/{month}(year=${nextMonth.year}, month=${nextMonth.monthValue})}"
                hx-target="#calendar-grid"
                class="p-2 hover:bg-gray-100 rounded-full">
            →
        </button>
    </div>

    <!-- 요일 헤더 -->
    <div class="grid grid-cols-7 gap-1 mb-2">
        <div th:each="day : ${ {'일','월','화','수','목','금','토'} }"
             class="text-center text-xs text-gray-400 py-2"
             th:text="${day}">월</div>
    </div>

    <!-- 캘린더 날짜 -->
    <div class="grid grid-cols-7 gap-1">
        <div th:each="day : ${calendarDays}"
             th:class="${day.isCurrentMonth ? '' : 'opacity-30'}"
             class="aspect-square flex items-center justify-center relative">

            <button th:if="${day.isCurrentMonth && !day.isFuture}"
                    @click="openDayDetail(/*[[${day.date}]]*/ '')"
                    th:classappend="${day.isToday ? 'ring-2 ring-emerald-400' : ''}"
                    class="w-10 h-10 rounded-full flex items-center justify-center">

                <!-- 금주 -->
                <span th:if="${day.isSober}" class="text-emerald-500 text-lg">⭕</span>
                <!-- 음주 -->
                <span th:if="${day.isSober == false}" class="text-gray-400 text-lg">❌</span>
                <!-- 기록 없음 -->
                <span th:if="${day.isSober == null}" class="text-gray-300" th:text="${day.dayOfMonth}">1</span>
            </button>

            <!-- 미래 날짜 -->
            <span th:if="${day.isFuture}" class="text-gray-200" th:text="${day.dayOfMonth}">1</span>
        </div>
    </div>
</div>
```

### 바텀시트 (Alpine.js) 예시

```html
<div x-data="{ open: false, selectedDate: null, checkIn: null }"
     @open-day-detail.window="open = true; selectedDate = $event.detail.date; checkIn = $event.detail.checkIn">

    <!-- 오버레이 -->
    <div x-show="open" @click="open = false"
         class="fixed inset-0 bg-black bg-opacity-50 z-40"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"></div>

    <!-- 바텀시트 -->
    <div x-show="open"
         class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-50 p-6 pb-safe"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="translate-y-full"
         x-transition:enter-end="translate-y-0">

        <div class="text-center">
            <p class="text-lg font-semibold" x-text="selectedDate">2026년 1월 15일</p>
            <div class="my-4">
                <span x-show="checkIn?.isSober" class="text-4xl">⭕</span>
                <span x-show="checkIn?.isSober === false" class="text-4xl">❌</span>
                <span x-show="!checkIn" class="text-gray-400">기록 없음</span>
            </div>
            <button @click="open = false" class="text-gray-500">닫기</button>
        </div>
    </div>
</div>
```

---

## Testing

### 이 스토리의 테스트 요구사항

| 테스트 파일 | 테스트 내용 |
|------------|------------|
| `CalendarControllerTest.kt` | 캘린더 페이지 렌더링, 월 데이터 조회 |
| `CheckInServiceTest.kt` | 월별 체크인 조회 로직 |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | 스토리 초안 작성 | PO Sarah |

---

## Dev Agent Record

### Agent Model Used
*(개발 에이전트가 구현 시 기록)*

### Debug Log References
*(개발 중 생성된 디버그 로그 참조)*

### Completion Notes List
*(태스크 완료 및 이슈 노트)*

### File List
*(구현 중 생성/수정된 파일 목록)*

---

## QA Results
*(QA 에이전트의 리뷰 결과)*
