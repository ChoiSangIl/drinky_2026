# Story 1.2: 사용자 인증 백엔드 구성

## Status

**Ready for Review**

---

## Story

**As a** 사용자,
**I want** 소셜 계정으로 가입/로그인할 수 있어서,
**so that** 내 음주 기록을 안전하게 저장하고 관리할 수 있다.

---

## Acceptance Criteria

1. Spring Security + OAuth2 Client 설정 완료
2. Google OAuth 로그인 설정 완료
3. Kakao OAuth 로그인 설정 완료
4. users 테이블 스키마 생성 (id, email, nickname, provider, provider_id, created_at)
5. OAuth 로그인 성공 시 CustomOAuth2UserService에서 사용자 자동 생성/조회
6. 세션 기반 인증 + Remember Me (7일) 설정

---

## Tasks / Subtasks

- [x] **Task 1: 데이터베이스 스키마 생성** (AC: 4)
  - [x] Flyway 마이그레이션 파일 (`V1__init_schema.sql`) - Story 1.1에서 이미 생성됨
  - [x] `users` 테이블 생성 (스키마 포함)
  - [x] 인덱스 생성 (`idx_users_email`, `idx_users_provider`)

- [x] **Task 2: JPA 엔티티 및 Repository 생성** (AC: 4, 5)
  - [x] `AuthProvider` enum 생성 (`GOOGLE`, `KAKAO`)
  - [x] `User` 엔티티 생성 (`domain/entity/User.kt`)
  - [x] `UserRepository` 인터페이스 생성
    - [x] `findByEmail(email: String): User?`
    - [x] `findByProviderAndProviderId(provider: AuthProvider, providerId: String): User?`

- [x] **Task 3: Spring Security 기본 설정** (AC: 1, 6)
  - [x] `SecurityConfig.kt` 업데이트 (OAuth2 + Remember Me)
  - [x] SecurityFilterChain 설정
    - [x] 공개 경로 설정 (`/`, `/login`, `/health`, `/static/**`, `/error`, `/h2-console/**`)
    - [x] 그 외 경로 인증 필요
  - [x] 세션 관리 설정
  - [x] Remember Me 설정 (7일, 쿠키 기반, CustomUserDetailsService)
  - [x] CSRF 설정 (H2 콘솔 제외)
  - [x] 로그아웃 설정 (`/logout`)

- [x] **Task 4: Google OAuth 설정** (AC: 2)
  - [x] `application-local.yml` / `application-dev.yml`에 Google OAuth 설정 추가
  - [x] 환경 변수 설정 (`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`)
  - [ ] Google Cloud Console에서 OAuth 2.0 클라이언트 생성 - *사용자 수동 작업 필요*

- [x] **Task 5: Kakao OAuth 설정** (AC: 3)
  - [x] `application-local.yml` / `application-dev.yml`에 Kakao OAuth 설정 추가 (커스텀 Provider)
  - [x] 환경 변수 설정 (`KAKAO_CLIENT_ID`, `KAKAO_CLIENT_SECRET`)
  - [ ] Kakao Developers에서 애플리케이션 생성 - *사용자 수동 작업 필요*

- [x] **Task 6: CustomOAuth2UserService 구현** (AC: 5)
  - [x] `CustomOAuth2UserService.kt` 생성
  - [x] `loadUser()` 메서드 오버라이드
    - [x] OAuth2 사용자 정보 추출 (email, name, picture)
    - [x] Provider별 응답 파싱 (Google vs Kakao 차이 처리)
    - [x] 기존 사용자 조회 또는 신규 사용자 생성
    - [x] `UserPrincipal` 반환
  - [x] `UserPrincipal.kt` 생성 (OAuth2User 구현체)
  - [x] `OAuth2SuccessHandler.kt` 생성 (로그인 성공 후 `/dashboard` 리다이렉트)

- [x] **Task 7: UserService 구현** (AC: 5)
  - [x] `UserService.kt` 생성
  - [x] `findOrCreateUser()` 메서드 구현

- [x] **Task 8: 테스트** (AC: 1, 2, 3, 6)
  - [x] `UserRepositoryTest.kt` - 사용자 조회/생성 Repository 테스트
  - [x] `CustomOAuth2UserServiceTest.kt` - OAuth2 사용자 로드 및 생성 테스트
  - [x] `SecurityConfigTest.kt` - 보안 설정 (공개/인증 경로) 통합 테스트
  - [ ] 실제 OAuth 로그인 테스트 - *Google/Kakao 클라이언트 생성 후 수동 검증 필요*

---

## Dev Notes

### 프로젝트 구조 (이 스토리 관련)

```
src/main/kotlin/com/drinky/
├── config/
│   ├── SecurityConfig.kt          # Spring Security 설정
│   └── OAuth2Config.kt            # OAuth2 추가 설정 (선택)
├── domain/
│   ├── entity/
│   │   └── User.kt                # 사용자 엔티티
│   └── enums/
│       └── AuthProvider.kt        # GOOGLE, KAKAO enum
├── repository/
│   └── UserRepository.kt          # JPA Repository
├── service/
│   └── UserService.kt             # 사용자 비즈니스 로직
└── security/
    ├── CustomOAuth2UserService.kt # OAuth2 사용자 로드
    ├── OAuth2SuccessHandler.kt    # 로그인 성공 핸들러
    └── UserPrincipal.kt           # 인증된 사용자 Principal

src/main/resources/
├── application.yml                # OAuth2 설정 포함
└── db/migration/
    └── V1__init_schema.sql        # users 테이블 DDL
```

### User 엔티티 예시

```kotlin
@Entity
@Table(name = "users")
class User(
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    val id: UUID? = null,

    @Column(nullable = false, unique = true)
    val email: String,

    @Column(nullable = false, length = 50)
    var nickname: String,

    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    val provider: AuthProvider,

    @Column(name = "provider_id", nullable = false)
    val providerId: String,

    @Column(name = "profile_image", length = 500)
    var profileImage: String? = null,

    @Column(name = "created_at", nullable = false, updatable = false)
    val createdAt: LocalDateTime = LocalDateTime.now(),

    @Column(name = "updated_at", nullable = false)
    var updatedAt: LocalDateTime = LocalDateTime.now()
)
```

### SecurityConfig 예시

```kotlin
@Configuration
@EnableWebSecurity
class SecurityConfig(
    private val customOAuth2UserService: CustomOAuth2UserService,
    private val oAuth2SuccessHandler: OAuth2SuccessHandler
) {
    @Bean
    fun securityFilterChain(http: HttpSecurity): SecurityFilterChain {
        http
            .authorizeHttpRequests { auth ->
                auth
                    .requestMatchers("/", "/login", "/health", "/error").permitAll()
                    .requestMatchers("/static/**", "/css/**", "/js/**", "/icons/**").permitAll()
                    .anyRequest().authenticated()
            }
            .oauth2Login { oauth2 ->
                oauth2
                    .loginPage("/login")
                    .userInfoEndpoint { it.userService(customOAuth2UserService) }
                    .successHandler(oAuth2SuccessHandler)
            }
            .logout { logout ->
                logout
                    .logoutUrl("/logout")
                    .logoutSuccessUrl("/login?logout")
                    .invalidateHttpSession(true)
                    .deleteCookies("JSESSIONID", "remember-me")
            }
            .rememberMe { remember ->
                remember
                    .key("drinky-remember-me-key")
                    .tokenValiditySeconds(7 * 24 * 60 * 60) // 7일
            }

        return http.build()
    }
}
```

### OAuth2 Provider별 사용자 정보 매핑

| Provider | Email | Nickname | Profile Image | Provider ID |
|----------|-------|----------|---------------|-------------|
| **Google** | `email` | `name` | `picture` | `sub` |
| **Kakao** | `kakao_account.email` | `properties.nickname` | `properties.profile_image` | `id` |

### CustomOAuth2UserService 핵심 로직

```kotlin
@Service
class CustomOAuth2UserService(
    private val userRepository: UserRepository
) : DefaultOAuth2UserService() {

    override fun loadUser(userRequest: OAuth2UserRequest): OAuth2User {
        val oAuth2User = super.loadUser(userRequest)
        val registrationId = userRequest.clientRegistration.registrationId
        val provider = AuthProvider.valueOf(registrationId.uppercase())

        val oAuth2UserInfo = extractUserInfo(provider, oAuth2User.attributes)
        val user = userRepository.findByProviderAndProviderId(provider, oAuth2UserInfo.providerId)
            ?: createUser(provider, oAuth2UserInfo)

        return UserPrincipal.create(user, oAuth2User.attributes)
    }
}
```

### 환경 변수 (.env 추가)

```bash
# Google OAuth
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxx

# Kakao OAuth
KAKAO_CLIENT_ID=abcd1234
KAKAO_CLIENT_SECRET=xyz789
```

### 의존성 (build.gradle.kts)

```kotlin
dependencies {
    // Spring Security
    implementation("org.springframework.boot:spring-boot-starter-security")

    // OAuth2 Client
    implementation("org.springframework.boot:spring-boot-starter-oauth2-client")

    // JPA
    implementation("org.springframework.boot:spring-boot-starter-data-jpa")

    // PostgreSQL
    runtimeOnly("org.postgresql:postgresql")
}
```

---

## Testing

### 테스트 파일 위치
- `src/test/kotlin/com/drinky/`

### 테스트 표준
- **Framework:** JUnit 5 (5.10.1)
- **Mocking:** MockK (1.13.9)
- **Assertion:** AssertJ (3.25.1)
- **Security Test:** `@WithMockUser`, `@WithSecurityContext`

### 이 스토리의 테스트 요구사항

| 테스트 파일 | 테스트 내용 |
|------------|------------|
| `UserRepositoryTest.kt` | 사용자 조회/생성 Repository 테스트 |
| `CustomOAuth2UserServiceTest.kt` | OAuth2 사용자 로드 및 생성 테스트 |
| `SecurityConfigTest.kt` | 보안 설정 (공개/인증 경로) 통합 테스트 |

### 테스트 실행 명령어

```bash
# 전체 테스트
./gradlew test

# Security 관련 테스트
./gradlew test --tests "*Security*"
./gradlew test --tests "*OAuth*"
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | 스토리 초안 작성 | PO Sarah |
| 2026-02-02 | 0.2 | 전체 구현 완료 (Entity, Security, OAuth2, Service, Tests) | Dev James |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

*(개발 중 생성된 디버그 로그 참조)*

### Completion Notes List

- **Task 1**: Story 1.1에서 이미 V1__init_schema.sql 생성됨 (users 테이블 포함)
- **Task 3**: `rememberMe`가 `UserDetailsService`를 필요로 하여 `CustomUserDetailsService` 추가 구현
- **Task 4/5**: OAuth 클라이언트 설정은 yml에 완료. Kakao OAuth 클라이언트 생성 및 로그인 검증 완료. Google OAuth는 추후 설정 예정 (Google Cloud Console에서 클라이언트 생성 필요)
- **Task 6**: `CustomOAuth2UserService`에서 기존 사용자 프로필 변경 시 자동 업데이트 기능 포함
- **Task 8**: 단위/통합 테스트 통과. Kakao OAuth 로그인 수동 검증 완료. Google OAuth는 클라이언트 생성 후 검증 필요
- **추가 파일**: `login.html` 로그인 페이지 템플릿 생성, `HomeController`에 `/login` 매핑 추가
- **환경변수**: `spring-dotenv` 라이브러리 추가하여 `.env` 파일에서 환경변수 로드 방식으로 변경
- **CI/CD**: `.github/workflows/deploy.yml`은 GitHub OAuth 토큰 workflow scope 문제로 일단 gitignore에 추가하여 제외. 추후 workflow 권한 확보 시 복원 필요

### File List

**신규 생성:**
- `src/main/kotlin/com/drinky/domain/enums/AuthProvider.kt` - 인증 제공자 enum
- `src/main/kotlin/com/drinky/domain/entity/User.kt` - 사용자 JPA 엔티티
- `src/main/kotlin/com/drinky/repository/UserRepository.kt` - 사용자 Repository
- `src/main/kotlin/com/drinky/service/UserService.kt` - 사용자 비즈니스 로직
- `src/main/kotlin/com/drinky/security/CustomOAuth2UserService.kt` - OAuth2 사용자 로드
- `src/main/kotlin/com/drinky/security/UserPrincipal.kt` - 인증된 사용자 Principal
- `src/main/kotlin/com/drinky/security/OAuth2SuccessHandler.kt` - 로그인 성공 핸들러
- `src/main/kotlin/com/drinky/security/CustomUserDetailsService.kt` - Remember Me용 UserDetailsService
- `src/main/resources/templates/pages/login.html` - 로그인 페이지 템플릿
- `src/test/kotlin/com/drinky/repository/UserRepositoryTest.kt` - Repository 테스트
- `src/test/kotlin/com/drinky/security/CustomOAuth2UserServiceTest.kt` - OAuth2 서비스 테스트
- `src/test/kotlin/com/drinky/security/SecurityConfigTest.kt` - Security 통합 테스트

**수정:**
- `src/main/kotlin/com/drinky/config/SecurityConfig.kt` - OAuth2 + Remember Me + 경로 보안 설정
- `src/main/kotlin/com/drinky/controller/HomeController.kt` - `/login` 매핑 추가
- `src/test/resources/application-test.yml` - Kakao OAuth 테스트 설정 추가
- `src/test/kotlin/com/drinky/controller/HomeControllerTest.kt` - SpringBootTest로 변경

---

## QA Results

*(QA 에이전트의 리뷰 결과)*
