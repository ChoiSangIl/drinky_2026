# Story 2.4: í‘¸ì‹œ ì•Œë¦¼ ì¸í”„ë¼ êµ¬ì¶•

## Status

**Draft**

---

## Story

**As a** ì‚¬ìš©ì,
**I want** ì•±ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆì–´ì„œ,
**so that** ì•±ì„ ì—´ì§€ ì•Šì•„ë„ ì ˆì£¼ ë™ê¸°ë¶€ì—¬ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.

---

## Acceptance Criteria

1. Firebase Cloud Messaging (FCM) í”„ë¡œì íŠ¸ ì„¤ì • ë° Firebase Admin SDK ì—°ë™
2. PWA Service Worker (sw.js)ì— í‘¸ì‹œ ì•Œë¦¼ ìˆ˜ì‹  ë¡œì§ ì¶”ê°€
3. ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ UI êµ¬í˜„ (Alpine.js)
4. ì•Œë¦¼ ê¶Œí•œ ìˆ˜ë½ ì‹œ FCM í† í° ì €ì¥ (push_subscriptions í…Œì´ë¸”)
5. ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ë° ë‚˜ì¤‘ì— ë‹¤ì‹œ ë¬»ê¸°
6. í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ë° ìˆ˜ì‹  í™•ì¸
7. ì•Œë¦¼ í´ë¦­ ì‹œ ì•±ìœ¼ë¡œ ì´ë™

---

## Tasks / Subtasks

- [ ] **Task 1: Firebase í”„ë¡œì íŠ¸ ì„¤ì •** (AC: 1)
  - [ ] Firebase Consoleì—ì„œ í”„ë¡œì íŠ¸ ìƒì„±
  - [ ] Cloud Messaging í™œì„±í™”
  - [ ] Web Push ì¸ì¦ì„œ ìƒì„± (VAPID key)
  - [ ] ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON ë‹¤ìš´ë¡œë“œ

- [ ] **Task 2: Firebase Admin SDK ì—°ë™** (AC: 1)
  - [ ] `build.gradle.kts`ì— Firebase Admin SDK ì˜ì¡´ì„± ì¶”ê°€
    ```kotlin
    implementation("com.google.firebase:firebase-admin:9.2.0")
    ```
  - [ ] `FirebaseConfig.kt` ìƒì„±
  - [ ] ì„œë¹„ìŠ¤ ê³„ì • í‚¤ë¡œ ì´ˆê¸°í™”
  - [ ] í™˜ê²½ë³€ìˆ˜: `FIREBASE_CREDENTIALS_PATH`

- [ ] **Task 3: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ** (AC: 4)
  - [ ] `V4__create_push_subscriptions.sql` ìƒì„±
    ```sql
    CREATE TABLE push_subscriptions (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        fcm_token VARCHAR(500) NOT NULL,
        device_info VARCHAR(200),
        is_active BOOLEAN NOT NULL DEFAULT true,
        preferred_time TIME NOT NULL DEFAULT '21:00',
        created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX idx_push_user_active ON push_subscriptions(user_id, is_active);
    ```

- [ ] **Task 4: JPA ì—”í‹°í‹° ë° Repository** (AC: 4)
  - [ ] `PushSubscription` ì—”í‹°í‹° ìƒì„±
  - [ ] `PushSubscriptionRepository` ì¸í„°í˜ì´ìŠ¤ ìƒì„±
    - [ ] `findByUserIdAndIsActive(userId: UUID, isActive: Boolean): List<PushSubscription>`

- [ ] **Task 5: Service Worker ì„¤ì •** (AC: 2, 7)
  - [ ] `static/sw.js` ìƒì„±/ìˆ˜ì •
  - [ ] Firebase Messaging ì´ˆê¸°í™”
  - [ ] `push` ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  - [ ] `notificationclick` ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì•±ìœ¼ë¡œ ì´ë™)
  - [ ] `firebase-messaging-sw.js` í†µí•©

- [ ] **Task 6: í”„ë¡ íŠ¸ì—”ë“œ Firebase ì„¤ì •** (AC: 2, 3, 4)
  - [ ] `static/js/firebase-init.js` ìƒì„±
  - [ ] Firebase Web SDK ì´ˆê¸°í™”
  - [ ] FCM í† í° ìš”ì²­ ë¡œì§
  - [ ] í† í° ì„œë²„ ì „ì†¡ ë¡œì§

- [ ] **Task 7: ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ UI** (AC: 3, 5)
  - [ ] `templates/fragments/push-permission.html` ìƒì„±
  - [ ] ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬/ë°°ë„ˆ UI
  - [ ] "ì•Œë¦¼ ë°›ê¸°" ë²„íŠ¼
  - [ ] "ë‚˜ì¤‘ì—" ë²„íŠ¼ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥)
  - [ ] ê¶Œí•œ ê±°ë¶€ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€

- [ ] **Task 8: PushController ë° Service** (AC: 4, 6)
  - [ ] `PushController.kt` ìƒì„±
  - [ ] `POST /push/subscribe` - FCM í† í° ì €ì¥
  - [ ] `DELETE /push/unsubscribe` - êµ¬ë… í•´ì œ
  - [ ] `PushService.kt` ìƒì„±
  - [ ] `saveSubscription(userId, fcmToken, deviceInfo)`
  - [ ] `sendTestNotification(userId)` - í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡

- [ ] **Task 9: í…ŒìŠ¤íŠ¸ ì•Œë¦¼** (AC: 6)
  - [ ] ì„¤ì • í˜ì´ì§€ì— "í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°" ë²„íŠ¼
  - [ ] PushServiceë¡œ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡
  - [ ] ìˆ˜ì‹  í™•ì¸

---

## Dev Notes

### í”„ë¡œì íŠ¸ êµ¬ì¡° (ì´ ìŠ¤í† ë¦¬ ê´€ë ¨)

```
src/main/kotlin/com/drinky/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ FirebaseConfig.kt
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ PushController.kt
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ entity/
â”‚       â””â”€â”€ PushSubscription.kt
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ PushSubscriptionRepository.kt
â””â”€â”€ service/
    â””â”€â”€ PushService.kt

src/main/resources/static/
â”œâ”€â”€ js/
â”‚   â””â”€â”€ firebase-init.js
â””â”€â”€ sw.js (ë˜ëŠ” firebase-messaging-sw.js)

src/main/resources/templates/fragments/
â””â”€â”€ push-permission.html
```

### FirebaseConfig ì˜ˆì‹œ

```kotlin
@Configuration
class FirebaseConfig {

    @Value("\${firebase.credentials-path}")
    private lateinit var credentialsPath: String

    @PostConstruct
    fun initialize() {
        val serviceAccount = FileInputStream(credentialsPath)
        val options = FirebaseOptions.builder()
            .setCredentials(GoogleCredentials.fromStream(serviceAccount))
            .build()

        if (FirebaseApp.getApps().isEmpty()) {
            FirebaseApp.initializeApp(options)
        }
    }
}
```

### PushSubscription ì—”í‹°í‹°

```kotlin
@Entity
@Table(name = "push_subscriptions")
class PushSubscription(
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    val id: UUID? = null,

    @Column(name = "user_id", nullable = false)
    val userId: UUID,

    @Column(name = "fcm_token", nullable = false, length = 500)
    var fcmToken: String,

    @Column(name = "device_info", length = 200)
    var deviceInfo: String? = null,

    @Column(name = "is_active", nullable = false)
    var isActive: Boolean = true,

    @Column(name = "preferred_time", nullable = false)
    var preferredTime: LocalTime = LocalTime.of(21, 0),

    @Column(name = "created_at", nullable = false, updatable = false)
    val createdAt: LocalDateTime = LocalDateTime.now(),

    @Column(name = "updated_at", nullable = false)
    var updatedAt: LocalDateTime = LocalDateTime.now()
)
```

### PushService ì˜ˆì‹œ

```kotlin
@Service
class PushService(
    private val pushSubscriptionRepository: PushSubscriptionRepository
) {
    private val logger = LoggerFactory.getLogger(PushService::class.java)

    fun saveSubscription(userId: UUID, fcmToken: String, deviceInfo: String?) {
        val existing = pushSubscriptionRepository.findByUserIdAndFcmToken(userId, fcmToken)

        if (existing != null) {
            existing.isActive = true
            existing.updatedAt = LocalDateTime.now()
            pushSubscriptionRepository.save(existing)
        } else {
            val subscription = PushSubscription(
                userId = userId,
                fcmToken = fcmToken,
                deviceInfo = deviceInfo
            )
            pushSubscriptionRepository.save(subscription)
        }
    }

    fun sendNotification(fcmToken: String, title: String, body: String) {
        val message = Message.builder()
            .setToken(fcmToken)
            .setNotification(
                Notification.builder()
                    .setTitle(title)
                    .setBody(body)
                    .build()
            )
            .setWebpushConfig(
                WebpushConfig.builder()
                    .setFcmOptions(WebpushFcmOptions.builder().setLink("/").build())
                    .build()
            )
            .build()

        try {
            val response = FirebaseMessaging.getInstance().send(message)
            logger.info("Push sent: $response")
        } catch (e: FirebaseMessagingException) {
            logger.error("Push failed: ${e.message}")
            // í† í° ë¬´íš¨í™” ì²˜ë¦¬
            if (e.messagingErrorCode == MessagingErrorCode.UNREGISTERED) {
                deactivateToken(fcmToken)
            }
        }
    }
}
```

### Service Worker (sw.js) ì˜ˆì‹œ

```javascript
importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');

firebase.initializeApp({
    apiKey: "...",
    projectId: "drinky-app",
    messagingSenderId: "...",
    appId: "..."
});

const messaging = firebase.messaging();

// ë°±ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ 
messaging.onBackgroundMessage((payload) => {
    const { title, body } = payload.notification;

    self.registration.showNotification(title, {
        body: body,
        icon: '/icons/icon-192.png',
        badge: '/icons/badge-72.png',
        data: { url: '/' }
    });
});

// ì•Œë¦¼ í´ë¦­ ì‹œ ì•±ìœ¼ë¡œ ì´ë™
self.addEventListener('notificationclick', (event) => {
    event.notification.close();

    event.waitUntil(
        clients.matchAll({ type: 'window' }).then((clientList) => {
            for (const client of clientList) {
                if (client.url === '/' && 'focus' in client) {
                    return client.focus();
                }
            }
            if (clients.openWindow) {
                return clients.openWindow('/');
            }
        })
    );
});
```

### ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ UI

```html
<div th:fragment="permission"
     x-data="{ show: false, denied: false }"
     x-init="checkPermission()"
     x-show="show">

    <div class="fixed bottom-20 left-4 right-4 bg-white rounded-xl shadow-lg p-4 z-40">
        <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ””</span>
            <div class="flex-1">
                <p class="font-semibold">ì•Œë¦¼ì„ ë°›ì•„ë³´ì„¸ìš”!</p>
                <p class="text-sm text-gray-500">ë§¤ì¼ ì²´í¬ì¸ ì‹œê°„ì— ì•Œë ¤ë“œë¦´ê²Œìš”</p>
            </div>
        </div>
        <div class="flex gap-2 mt-4">
            <button @click="dismissPermission()" class="flex-1 py-2 border rounded-lg text-gray-500">
                ë‚˜ì¤‘ì—
            </button>
            <button @click="requestPermission()" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg">
                ì•Œë¦¼ ë°›ê¸°
            </button>
        </div>
    </div>
</div>

<script>
function checkPermission() {
    if (Notification.permission === 'default') {
        const dismissed = localStorage.getItem('pushDismissed');
        if (!dismissed) {
            this.show = true;
        }
    }
}

async function requestPermission() {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
        await subscribeToPush();
    }
    this.show = false;
}

function dismissPermission() {
    localStorage.setItem('pushDismissed', Date.now());
    this.show = false;
}
</script>
```

---

## Testing

### ì´ ìŠ¤í† ë¦¬ì˜ í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­

| í…ŒìŠ¤íŠ¸ íŒŒì¼ | í…ŒìŠ¤íŠ¸ ë‚´ìš© |
|------------|------------|
| `PushSubscriptionRepositoryTest.kt` | êµ¬ë… ì €ì¥/ì¡°íšŒ í…ŒìŠ¤íŠ¸ |
| `PushServiceTest.kt` | êµ¬ë… ë¡œì§, ì•Œë¦¼ ë°œì†¡ ë¡œì§ (Mock) |
| `PushControllerTest.kt` | êµ¬ë… API í…ŒìŠ¤íŠ¸ |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | ìŠ¤í† ë¦¬ ì´ˆì•ˆ ì‘ì„± | PO Sarah |

---

## Dev Agent Record

### Agent Model Used
*(ê°œë°œ ì—ì´ì „íŠ¸ê°€ êµ¬í˜„ ì‹œ ê¸°ë¡)*

### Debug Log References
*(ê°œë°œ ì¤‘ ìƒì„±ëœ ë””ë²„ê·¸ ë¡œê·¸ ì°¸ì¡°)*

### Completion Notes List
*(íƒœìŠ¤í¬ ì™„ë£Œ ë° ì´ìŠˆ ë…¸íŠ¸)*

### File List
*(êµ¬í˜„ ì¤‘ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡)*

---

## QA Results
*(QA ì—ì´ì „íŠ¸ì˜ ë¦¬ë·° ê²°ê³¼)*
