# Story 2.3: 과거 기록 조회 및 수정

## Status

**Draft**

---

## Story

**As a** 사용자,
**I want** 최근 7일 이내의 기록을 수정할 수 있어서,
**so that** 깜빡하고 기록하지 못한 날을 보완할 수 있다.

---

## Acceptance Criteria

1. 캘린더 뷰에서 날짜 클릭 시 기록 상세 표시
2. 7일 이내 날짜는 수정 버튼 활성화
3. 7일 초과 날짜는 수정 버튼 비활성화 + 안내 메시지
4. 기록 수정 시 확인 다이얼로그 표시
5. 기록 없는 과거 날짜에 새 기록 추가 가능 (7일 이내)
6. 수정 완료 시 스트릭 자동 재계산
7. 수정 이력 로깅 (데이터 무결성용)

---

## Tasks / Subtasks

- [ ] **Task 1: 수정 가능 여부 로직** (AC: 2, 3)
  - [ ] `CheckInService` 확장
  - [ ] `isEditable(checkDate: LocalDate): Boolean` - 7일 이내 여부 확인
  - [ ] 상수 정의: `MAX_EDIT_DAYS = 7`

- [ ] **Task 2: 과거 기록 수정 API** (AC: 4, 5, 6)
  - [ ] `CheckInController` 확장
  - [ ] `POST /checkin/{date}` - 특정 날짜 체크인 저장/수정
    - [ ] Path Variable: `date` (yyyy-MM-dd)
    - [ ] Request: `isSober: Boolean`
  - [ ] 7일 초과 시 400 Bad Request 응답

- [ ] **Task 3: 날짜 상세 바텀시트 확장** (AC: 1, 2, 3)
  - [ ] `day-detail.html` 수정
  - [ ] 수정 가능 여부에 따른 UI 분기
  - [ ] 수정 가능: O/X 버튼 표시
  - [ ] 수정 불가: "7일이 지나 수정할 수 없어요" 메시지

- [ ] **Task 4: 수정 확인 다이얼로그** (AC: 4)
  - [ ] Alpine.js 모달 컴포넌트
  - [ ] "기록을 수정하시겠습니까?" 확인
  - [ ] 확인/취소 버튼

- [ ] **Task 5: 새 기록 추가** (AC: 5)
  - [ ] 기록 없는 과거 날짜 클릭 시
  - [ ] "기록 추가하기" 버튼 표시
  - [ ] O/X 선택 UI

- [ ] **Task 6: 스트릭 재계산** (AC: 6)
  - [ ] `StreakService.recalculateStreak(userId: UUID)`
  - [ ] 전체 체크인 기록 기반 스트릭 재계산
  - [ ] 과거 기록 수정 시 호출

- [ ] **Task 7: 수정 이력 로깅** (AC: 7)
  - [ ] `check_in_logs` 테이블 생성 (선택사항)
    ```sql
    CREATE TABLE check_in_logs (
        id UUID PRIMARY KEY,
        check_in_id UUID REFERENCES check_ins(id),
        user_id UUID REFERENCES users(id),
        action VARCHAR(20), -- CREATE, UPDATE
        old_value BOOLEAN,
        new_value BOOLEAN,
        created_at TIMESTAMP
    );
    ```
  - [ ] 또는 애플리케이션 로그로 기록
  - [ ] 수정 시 이전 값, 새 값, 시간 기록

- [ ] **Task 8: UI 업데이트** (AC: 6)
  - [ ] 수정 완료 후 캘린더 새로고침
  - [ ] HTMX로 해당 날짜 셀 업데이트
  - [ ] 스트릭 영역 업데이트 (대시보드 연동)

---

## Dev Notes

### 프로젝트 구조 (이 스토리 관련)

```
src/main/kotlin/com/drinky/
├── controller/
│   └── CheckInController.kt (확장)
├── service/
│   ├── CheckInService.kt (확장)
│   └── StreakService.kt (확장)
└── domain/
    └── entity/
        └── CheckInLog.kt (선택)

src/main/resources/templates/
└── fragments/
    ├── day-detail.html (수정)
    └── edit-confirm-modal.html
```

### CheckInController 확장

```kotlin
@PostMapping("/{date}")
fun checkInForDate(
    @AuthenticationPrincipal principal: UserPrincipal,
    @PathVariable @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) date: LocalDate,
    @RequestParam isSober: Boolean,
    model: Model
): String {
    // 수정 가능 여부 확인
    if (!checkInService.isEditable(date)) {
        throw ResponseStatusException(HttpStatus.BAD_REQUEST, "7일이 지난 기록은 수정할 수 없습니다.")
    }

    val checkIn = checkInService.checkInForDate(principal.userId, date, isSober)

    // 스트릭 재계산
    streakService.recalculateStreak(principal.userId)

    model.addAttribute("checkIn", checkIn)
    model.addAttribute("message", "기록이 수정되었습니다.")

    return "fragments/day-detail :: updated"
}
```

### 수정 가능 여부 확인

```kotlin
@Service
class CheckInService {
    companion object {
        const val MAX_EDIT_DAYS = 7L
    }

    fun isEditable(checkDate: LocalDate): Boolean {
        val today = LocalDate.now()
        val daysAgo = ChronoUnit.DAYS.between(checkDate, today)
        return daysAgo in 0..MAX_EDIT_DAYS && !checkDate.isAfter(today)
    }
}
```

### 스트릭 재계산 로직

```kotlin
@Service
class StreakService {
    @Transactional
    fun recalculateStreak(userId: UUID) {
        val checkIns = checkInRepository.findByUserIdOrderByCheckDateAsc(userId)
        val streak = getOrCreateStreak(userId)

        var currentStreak = 0
        var longestStreak = 0
        var streakStartDate: LocalDate? = null
        var lastSoberDate: LocalDate? = null

        for (checkIn in checkIns) {
            if (checkIn.isSober) {
                if (lastSoberDate == null || lastSoberDate.plusDays(1) == checkIn.checkDate) {
                    currentStreak++
                    if (streakStartDate == null) {
                        streakStartDate = checkIn.checkDate
                    }
                } else {
                    currentStreak = 1
                    streakStartDate = checkIn.checkDate
                }
                lastSoberDate = checkIn.checkDate
                longestStreak = maxOf(longestStreak, currentStreak)
            } else {
                currentStreak = 0
                streakStartDate = null
                lastSoberDate = null
            }
        }

        streak.currentStreak = currentStreak
        streak.longestStreak = maxOf(streak.longestStreak, longestStreak)
        streak.streakStartDate = streakStartDate
        streak.lastCheckDate = checkIns.lastOrNull()?.checkDate
        streakRepository.save(streak)
    }
}
```

### 날짜 상세 바텀시트 (수정 기능 포함)

```html
<div th:fragment="detail" x-data="{ showConfirm: false, newValue: null }">
    <div class="text-center">
        <p class="text-lg font-semibold mb-2" th:text="${#temporals.format(date, 'yyyy년 M월 d일')}">
            2026년 1월 15일
        </p>

        <!-- 현재 기록 표시 -->
        <div class="my-4">
            <span th:if="${checkIn?.isSober}" class="text-4xl">⭕</span>
            <span th:if="${checkIn?.isSober == false}" class="text-4xl">❌</span>
            <span th:if="${checkIn == null}" class="text-gray-400">기록 없음</span>
        </div>

        <!-- 수정 가능한 경우 -->
        <div th:if="${editable}" class="space-y-4">
            <p class="text-sm text-gray-500">기록을 수정하시겠습니까?</p>
            <div class="flex justify-center gap-4">
                <button @click="newValue = true; showConfirm = true"
                        class="w-16 h-16 rounded-full bg-emerald-100 flex items-center justify-center">
                    <span class="text-2xl">⭕</span>
                </button>
                <button @click="newValue = false; showConfirm = true"
                        class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center">
                    <span class="text-2xl">❌</span>
                </button>
            </div>
        </div>

        <!-- 수정 불가능한 경우 -->
        <div th:unless="${editable}" class="mt-4">
            <p class="text-sm text-gray-400">7일이 지나 수정할 수 없어요</p>
        </div>
    </div>

    <!-- 확인 모달 -->
    <div x-show="showConfirm" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 shadow-lg max-w-xs w-full mx-4">
            <p class="text-center mb-4">기록을 수정하시겠습니까?</p>
            <div class="flex gap-3">
                <button @click="showConfirm = false"
                        class="flex-1 py-2 border rounded-lg">취소</button>
                <button hx-post="@{/checkin/{date}(date=${date})}"
                        :hx-vals="JSON.stringify({isSober: newValue})"
                        hx-target="#day-detail-content"
                        @click="showConfirm = false"
                        class="flex-1 py-2 bg-emerald-500 text-white rounded-lg">확인</button>
            </div>
        </div>
    </div>
</div>
```

---

## Testing

### 이 스토리의 테스트 요구사항

| 테스트 파일 | 테스트 내용 |
|------------|------------|
| `CheckInServiceTest.kt` | 수정 가능 여부 로직, 과거 날짜 체크인 |
| `StreakServiceTest.kt` | 스트릭 재계산 로직 |
| `CheckInControllerTest.kt` | 과거 기록 수정 API, 7일 초과 에러 |

### 테스트 케이스 예시

```kotlin
@Test
fun `7일 이내 기록은 수정 가능`() {
    val date = LocalDate.now().minusDays(5)
    assertThat(checkInService.isEditable(date)).isTrue()
}

@Test
fun `7일 초과 기록은 수정 불가`() {
    val date = LocalDate.now().minusDays(8)
    assertThat(checkInService.isEditable(date)).isFalse()
}

@Test
fun `미래 날짜는 수정 불가`() {
    val date = LocalDate.now().plusDays(1)
    assertThat(checkInService.isEditable(date)).isFalse()
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | 스토리 초안 작성 | PO Sarah |

---

## Dev Agent Record

### Agent Model Used
*(개발 에이전트가 구현 시 기록)*

### Debug Log References
*(개발 중 생성된 디버그 로그 참조)*

### Completion Notes List
*(태스크 완료 및 이슈 노트)*

### File List
*(구현 중 생성/수정된 파일 목록)*

---

## QA Results
*(QA 에이전트의 리뷰 결과)*
