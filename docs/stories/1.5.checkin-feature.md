# Story 1.5: O/X 체크인 기능

## Status

**Ready for Review**

---

## Story

**As a** 사용자,
**I want** 오늘 술을 마셨는지 O/X 버튼 하나로 기록할 수 있어서,
**so that** 매일 1초 만에 간편하게 음주 여부를 기록할 수 있다.

---

## Acceptance Criteria

1. 대시보드에 ⭕(안마심) / ❌(마심) 버튼 표시
2. check_ins 테이블 생성 (id, user_id, check_date, is_sober, created_at)
3. HTMX로 버튼 클릭 시 체크인 저장 (POST /checkin)
4. 저장 성공 시 HTML Fragment 응답으로 즉시 UI 업데이트 (격려 메시지 포함)
5. 오늘 이미 기록한 경우 현재 상태 표시 및 수정 가능
6. 체크인 인터랙션 100ms 이내 반응
7. Service 레이어에서 본인 기록만 조회/수정 가능하도록 구현

---

## Tasks / Subtasks

- [x] **Task 1: 데이터베이스 스키마** (AC: 2)
  - [x] `check_ins` 테이블 - V1__init_schema.sql에 이미 존재
  - [x] 인덱스 `idx_check_ins_user_date` 포함

- [x] **Task 2: JPA 엔티티 및 Repository** (AC: 2)
  - [x] `CheckIn` 엔티티 생성 (`domain/entity/CheckIn.kt`)
  - [x] `CheckInRepository` 인터페이스 생성
    - [x] `findByUserIdAndCheckDate()`
    - [x] `findByUserIdOrderByCheckDateDesc()`
    - [x] `findByUserIdAndCheckDateBetween()` - 추가

- [x] **Task 3: CheckInService 구현** (AC: 3, 5, 7)
  - [x] `CheckInService.kt` 생성
  - [x] `getTodayCheckIn()` - 오늘 체크인 조회
  - [x] `checkIn()` - 체크인 저장/수정 (기존 있으면 업데이트)
  - [x] `getRecentCheckIns()` - 최근 N일 체크인 조회

- [x] **Task 4: CheckInController 구현** (AC: 3, 4)
  - [x] `CheckInController.kt` 생성
  - [x] `POST /checkin` - 체크인 저장, Fragment 응답
  - [x] `GET /checkin/today` - 오늘 체크인 상태 조회
  - [x] `edit=true` 파라미터로 수정 모드 지원

- [x] **Task 5: 체크인 버튼 UI** (AC: 1, 5)
  - [x] `templates/fragments/checkin-buttons.html` 생성
  - [x] ⭕ 버튼 (안마심, emerald-100)
  - [x] ❌ 버튼 (마심, gray-100)
  - [x] HTMX hx-post, hx-vals, hx-target, hx-swap 설정
  - [x] 터치 최적화 (min-w-[96px], active:scale-95)

- [x] **Task 6: 체크인 결과 UI** (AC: 4, 5)
  - [x] `templates/fragments/checkin-result.html` 생성
  - [x] 결과 아이콘 + 격려 메시지 표시
  - [x] "다시 선택하기" 버튼 (hx-get)
  - [x] Alpine.js transition 애니메이션

- [x] **Task 7: 격려 메시지 시스템** (AC: 4)
  - [x] `EncouragementMessages.kt` object 생성
  - [x] is_sober = true 메시지 7종
  - [x] is_sober = false 메시지 7종
  - [x] `getRandom(isSober)` 메서드

- [x] **Task 8: 대시보드 통합** (AC: 1, 5)
  - [x] `home.html` 체크인 영역에 HTMX 로드 (hx-trigger="load")
  - [x] 로딩 상태 플레이스홀더 (animate-pulse)

- [x] **Task 9: 성능 최적화** (AC: 6)
  - [x] HTMX Fragment 응답 (최소 HTML)
  - [x] DB 인덱스 활용 (idx_check_ins_user_date)

---

## Dev Notes

### 프로젝트 구조 (이 스토리 관련)

```
src/main/kotlin/com/drinky/
├── controller/
│   └── CheckInController.kt
├── domain/
│   ├── entity/
│   │   └── CheckIn.kt
│   └── dto/
│       ├── CheckInRequest.kt
│       └── CheckInResponse.kt
├── repository/
│   └── CheckInRepository.kt
├── service/
│   └── CheckInService.kt
└── util/
    └── EncouragementMessages.kt

src/main/resources/templates/
└── fragments/
    ├── checkin-buttons.html
    └── checkin-result.html
```

### CheckIn 엔티티

```kotlin
@Entity
@Table(name = "check_ins")
class CheckIn(
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    val id: UUID? = null,

    @Column(name = "user_id", nullable = false)
    val userId: UUID,

    @Column(name = "check_date", nullable = false)
    val checkDate: LocalDate,

    @Column(name = "is_sober", nullable = false)
    var isSober: Boolean,

    @Column(length = 200)
    var note: String? = null,

    @Column(name = "created_at", nullable = false, updatable = false)
    val createdAt: LocalDateTime = LocalDateTime.now()
)
```

### CheckInController 예시

```kotlin
@Controller
@RequestMapping("/checkin")
class CheckInController(
    private val checkInService: CheckInService
) {
    @PostMapping
    fun checkIn(
        @AuthenticationPrincipal principal: UserPrincipal,
        @RequestParam isSober: Boolean,
        model: Model
    ): String {
        val checkIn = checkInService.checkIn(principal.userId, isSober)
        val message = EncouragementMessages.getRandom(isSober)

        model.addAttribute("checkIn", checkIn)
        model.addAttribute("message", message)

        return "fragments/checkin-result"
    }

    @GetMapping("/today")
    fun getTodayCheckIn(
        @AuthenticationPrincipal principal: UserPrincipal,
        model: Model
    ): String {
        val checkIn = checkInService.getTodayCheckIn(principal.userId)

        return if (checkIn != null) {
            model.addAttribute("checkIn", checkIn)
            "fragments/checkin-result"
        } else {
            "fragments/checkin-buttons"
        }
    }
}
```

### HTMX 체크인 버튼 예시

```html
<div th:fragment="buttons" id="checkin-area" class="flex justify-center gap-8">
    <!-- 안마심 버튼 -->
    <button
        hx-post="/checkin"
        hx-vals='{"isSober": true}'
        hx-target="#checkin-area"
        hx-swap="innerHTML transition:true"
        class="w-24 h-24 rounded-full bg-emerald-100 hover:bg-emerald-200
               flex flex-col items-center justify-center transition-all
               active:scale-95 touch-manipulation">
        <span class="text-4xl">⭕</span>
        <span class="text-xs text-emerald-700 mt-1">안 마셨어요</span>
    </button>

    <!-- 마심 버튼 -->
    <button
        hx-post="/checkin"
        hx-vals='{"isSober": false}'
        hx-target="#checkin-area"
        hx-swap="innerHTML transition:true"
        class="w-24 h-24 rounded-full bg-gray-100 hover:bg-gray-200
               flex flex-col items-center justify-center transition-all
               active:scale-95 touch-manipulation">
        <span class="text-4xl">❌</span>
        <span class="text-xs text-gray-600 mt-1">마셨어요</span>
    </button>
</div>
```

### 체크인 결과 Fragment 예시

```html
<div th:fragment="result" id="checkin-area"
     x-data="{ show: false }"
     x-init="setTimeout(() => show = true, 100)"
     x-show="show"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 scale-90"
     x-transition:enter-end="opacity-100 scale-100">

    <div th:if="${checkIn.isSober}" class="text-center">
        <div class="w-20 h-20 mx-auto bg-emerald-100 rounded-full flex items-center justify-center mb-4">
            <span class="text-5xl">⭕</span>
        </div>
        <p class="text-lg font-semibold text-emerald-600" th:text="${message}">오늘도 건강한 선택!</p>
    </div>

    <div th:unless="${checkIn.isSober}" class="text-center">
        <div class="w-20 h-20 mx-auto bg-orange-100 rounded-full flex items-center justify-center mb-4">
            <span class="text-5xl">❌</span>
        </div>
        <p class="text-lg font-semibold text-gray-600" th:text="${message}">괜찮아요, 내일 다시!</p>
    </div>

    <button
        hx-get="/checkin/today?edit=true"
        hx-target="#checkin-area"
        hx-swap="innerHTML"
        class="mt-4 text-sm text-gray-400 hover:text-gray-600">
        다시 선택하기
    </button>
</div>
```

---

## Testing

### 이 스토리의 테스트 요구사항

| 테스트 파일 | 테스트 내용 |
|------------|------------|
| `CheckInRepositoryTest.kt` | 체크인 CRUD, 유니크 제약조건 테스트 |
| `CheckInServiceTest.kt` | 체크인 로직, 본인 데이터 접근 검증 |
| `CheckInControllerTest.kt` | HTMX 요청/응답, Fragment 반환 테스트 |

### CheckInServiceTest 예시

```kotlin
class CheckInServiceTest {

    @Test
    fun `오늘 첫 체크인 성공`() {
        // given
        val userId = UUID.randomUUID()
        val isSober = true

        // when
        val checkIn = checkInService.checkIn(userId, isSober)

        // then
        assertThat(checkIn.userId).isEqualTo(userId)
        assertThat(checkIn.checkDate).isEqualTo(LocalDate.now())
        assertThat(checkIn.isSober).isTrue()
    }

    @Test
    fun `오늘 체크인 수정 성공`() {
        // given - 이미 체크인한 상태
        val userId = UUID.randomUUID()
        checkInService.checkIn(userId, true)

        // when - 수정
        val updated = checkInService.checkIn(userId, false)

        // then
        assertThat(updated.isSober).isFalse()
    }
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | 스토리 초안 작성 | PO Sarah |
| 2026-02-05 | 0.2 | 전체 구현 완료 (체크인 CRUD, HTMX UI, 격려 메시지) | Dev James |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
*(개발 중 생성된 디버그 로그 참조)*

### Completion Notes List
- **Task 1**: check_ins 테이블은 V1__init_schema.sql에 이미 존재. 별도 마이그레이션 불필요.
- **Task 2**: `findByUserIdAndCheckDateBetween()` 추가하여 주간 조회 지원.
- **Task 4**: `edit=true` 파라미터로 "다시 선택하기" 기능 구현.
- **Task 7**: 각 상태별 7종 메시지 (총 14종). `List.random()` 사용.
- **Task 8**: HTMX `hx-trigger="load"`로 페이지 로드 시 자동 체크인 상태 로드.

### File List
**신규 생성:**
- `src/main/kotlin/com/drinky/domain/entity/CheckIn.kt` - 체크인 JPA 엔티티
- `src/main/kotlin/com/drinky/repository/CheckInRepository.kt` - 체크인 Repository
- `src/main/kotlin/com/drinky/service/CheckInService.kt` - 체크인 비즈니스 로직
- `src/main/kotlin/com/drinky/controller/CheckInController.kt` - 체크인 컨트롤러
- `src/main/kotlin/com/drinky/util/EncouragementMessages.kt` - 격려 메시지 시스템
- `src/main/resources/templates/fragments/checkin-buttons.html` - 체크인 버튼 프래그먼트
- `src/main/resources/templates/fragments/checkin-result.html` - 체크인 결과 프래그먼트
- `src/test/kotlin/com/drinky/repository/CheckInRepositoryTest.kt` - Repository 테스트
- `src/test/kotlin/com/drinky/service/CheckInServiceTest.kt` - Service 테스트
- `src/test/kotlin/com/drinky/controller/CheckInControllerTest.kt` - Controller 테스트

**수정:**
- `src/main/resources/templates/pages/home.html` - HTMX 체크인 영역 통합

---

## QA Results
*(QA 에이전트의 리뷰 결과)*
