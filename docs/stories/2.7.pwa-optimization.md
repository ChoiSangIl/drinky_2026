# Story 2.7: PWA 최적화 및 MVP 마무리

## Status

**Draft**

---

## Story

**As a** 사용자,
**I want** 앱을 홈 화면에 추가하고 오프라인에서도 기본 기능을 사용할 수 있어서,
**so that** 네이티브 앱처럼 편리하게 사용할 수 있다.

---

## Acceptance Criteria

1. Web App Manifest (manifest.json) 최적화 (아이콘, 테마 컬러, 시작 URL)
2. "홈 화면에 추가" 프롬프트 구현 (Alpine.js로 적절한 타이밍에)
3. Workbox 기반 오프라인 캐싱 전략 구현:
   - 정적 자산 캐싱 (CSS, JS, 아이콘)
   - 최근 기록 데이터 로컬 캐싱
   - 오프라인 시 체크인 → 온라인 복귀 시 동기화
4. 앱 로딩 스플래시 화면
5. Lighthouse PWA 점수 90점 이상
6. 성능 최적화 (첫 로딩 3초 이내)
7. 크로스 브라우저 테스트 (Chrome, Safari, Samsung Internet)

---

## Tasks / Subtasks

- [ ] **Task 1: Web App Manifest 최적화** (AC: 1)
  - [ ] `static/manifest.json` 생성/수정
  - [ ] 앱 이름, 설명 설정
  - [ ] 테마 컬러, 배경 컬러 설정
  - [ ] 아이콘 세트 (192px, 512px, maskable)
  - [ ] display: standalone
  - [ ] start_url: /
  - [ ] scope: /

- [ ] **Task 2: 앱 아이콘 생성** (AC: 1)
  - [ ] `static/icons/icon-192.png`
  - [ ] `static/icons/icon-512.png`
  - [ ] `static/icons/icon-maskable.png` (안전 영역 고려)
  - [ ] `static/icons/favicon.ico`
  - [ ] `static/icons/apple-touch-icon.png` (iOS용)

- [ ] **Task 3: Service Worker 캐싱 전략** (AC: 3)
  - [ ] `static/sw.js` 확장
  - [ ] Workbox 라이브러리 활용
  - [ ] 캐싱 전략:
    - [ ] 정적 자산: Cache First
    - [ ] API 응답: Network First with Cache Fallback
    - [ ] 페이지: Stale While Revalidate

- [ ] **Task 4: 오프라인 체크인 동기화** (AC: 3)
  - [ ] IndexedDB에 오프라인 체크인 저장
  - [ ] Background Sync API 활용
  - [ ] 온라인 복귀 시 서버와 동기화
  - [ ] 충돌 해결 (서버 우선)

- [ ] **Task 5: 홈 화면 추가 프롬프트** (AC: 2)
  - [ ] `beforeinstallprompt` 이벤트 캡처
  - [ ] 적절한 타이밍에 프롬프트 표시
    - [ ] 3회 이상 방문 후
    - [ ] 체크인 1회 이상 완료 후
  - [ ] 커스텀 UI 배너
  - [ ] "나중에" 선택 시 7일 후 재표시

- [ ] **Task 6: 스플래시 화면** (AC: 4)
  - [ ] iOS용 apple-mobile-web-app 설정
  - [ ] 스플래시 이미지 생성
  - [ ] 로딩 애니메이션 (선택)

- [ ] **Task 7: 성능 최적화** (AC: 6)
  - [ ] CSS/JS 최소화
  - [ ] 이미지 최적화 (WebP)
  - [ ] 폰트 최적화 (preload, font-display)
  - [ ] Critical CSS 인라인
  - [ ] Lazy loading 적용

- [ ] **Task 8: Lighthouse 점수 검증** (AC: 5)
  - [ ] Performance 90+
  - [ ] Accessibility 90+
  - [ ] Best Practices 90+
  - [ ] SEO 90+
  - [ ] PWA 체크리스트 통과

- [ ] **Task 9: 크로스 브라우저 테스트** (AC: 7)
  - [ ] Chrome (Android) 테스트
  - [ ] Safari (iOS) 테스트
  - [ ] Samsung Internet 테스트
  - [ ] 홈 화면 추가 테스트 (각 브라우저)
  - [ ] 푸시 알림 테스트 (각 브라우저)

---

## Dev Notes

### 프로젝트 구조 (이 스토리 관련)

```
src/main/resources/static/
├── manifest.json
├── sw.js
├── icons/
│   ├── icon-192.png
│   ├── icon-512.png
│   ├── icon-maskable.png
│   ├── favicon.ico
│   └── apple-touch-icon.png
├── css/
│   └── output.css (minified)
└── js/
    ├── htmx.min.js
    ├── alpine.min.js
    └── app.js
```

### manifest.json 예시

```json
{
  "name": "Drinky - 건강한 음주 습관",
  "short_name": "Drinky",
  "description": "원터치 O/X 체크인으로 음주 습관을 관리하세요",
  "start_url": "/",
  "scope": "/",
  "display": "standalone",
  "orientation": "portrait",
  "theme_color": "#10B981",
  "background_color": "#FFFFFF",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-maskable.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable"
    }
  ],
  "screenshots": [
    {
      "src": "/screenshots/home.png",
      "sizes": "390x844",
      "type": "image/png",
      "form_factor": "narrow"
    }
  ]
}
```

### Service Worker (Workbox) 예시

```javascript
importScripts('https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-sw.js');

const { precacheAndRoute, matchPrecache } = workbox.precaching;
const { registerRoute, NavigationRoute } = workbox.routing;
const { CacheFirst, NetworkFirst, StaleWhileRevalidate } = workbox.strategies;
const { ExpirationPlugin } = workbox.expiration;
const { BackgroundSyncPlugin } = workbox.backgroundSync;

// Precache static assets
precacheAndRoute([
  { url: '/css/output.css', revision: '1' },
  { url: '/js/htmx.min.js', revision: '1' },
  { url: '/js/alpine.min.js', revision: '1' },
  { url: '/icons/icon-192.png', revision: '1' },
  { url: '/icons/icon-512.png', revision: '1' }
]);

// Cache static assets (Cache First)
registerRoute(
  ({ request }) => request.destination === 'style' ||
                   request.destination === 'script' ||
                   request.destination === 'image',
  new CacheFirst({
    cacheName: 'static-assets',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 50,
        maxAgeSeconds: 30 * 24 * 60 * 60 // 30일
      })
    ]
  })
);

// Cache pages (Stale While Revalidate)
registerRoute(
  ({ request }) => request.mode === 'navigate',
  new StaleWhileRevalidate({
    cacheName: 'pages',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 10,
        maxAgeSeconds: 24 * 60 * 60 // 1일
      })
    ]
  })
);

// Background Sync for offline check-ins
const bgSyncPlugin = new BackgroundSyncPlugin('checkinQueue', {
  maxRetentionTime: 24 * 60 // 24시간
});

registerRoute(
  ({ url }) => url.pathname === '/checkin',
  new NetworkFirst({
    cacheName: 'api-checkin',
    plugins: [bgSyncPlugin]
  }),
  'POST'
);

// Offline fallback
self.addEventListener('fetch', (event) => {
  if (event.request.mode === 'navigate') {
    event.respondWith(
      fetch(event.request).catch(() => {
        return caches.match('/offline.html');
      })
    );
  }
});
```

### 홈 화면 추가 프롬프트

```html
<div x-data="installPrompt()" x-show="showPrompt" x-cloak
     class="fixed bottom-24 left-4 right-4 bg-white rounded-xl shadow-lg p-4 z-50">
    <div class="flex items-center gap-3">
        <img src="/icons/icon-192.png" class="w-12 h-12 rounded-lg" alt="Drinky">
        <div class="flex-1">
            <p class="font-semibold text-gray-800">Drinky 앱 설치</p>
            <p class="text-sm text-gray-500">홈 화면에 추가하고 더 빠르게 사용하세요</p>
        </div>
    </div>
    <div class="flex gap-2 mt-4">
        <button @click="dismissPrompt()" class="flex-1 py-2 border rounded-lg text-gray-500">
            나중에
        </button>
        <button @click="installApp()" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg">
            설치하기
        </button>
    </div>
</div>

<script>
function installPrompt() {
    return {
        showPrompt: false,
        deferredPrompt: null,

        init() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                this.deferredPrompt = e;

                // 조건 확인 (3회 이상 방문, 7일 내 거절 아님)
                const visits = parseInt(localStorage.getItem('visits') || '0') + 1;
                localStorage.setItem('visits', visits);

                const dismissed = localStorage.getItem('installDismissed');
                const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

                if (visits >= 3 && (!dismissed || parseInt(dismissed) < weekAgo)) {
                    this.showPrompt = true;
                }
            });
        },

        async installApp() {
            if (!this.deferredPrompt) return;

            this.deferredPrompt.prompt();
            const { outcome } = await this.deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                console.log('User accepted install');
            }

            this.deferredPrompt = null;
            this.showPrompt = false;
        },

        dismissPrompt() {
            localStorage.setItem('installDismissed', Date.now());
            this.showPrompt = false;
        }
    };
}
</script>
```

### 오프라인 체크인 동기화

```javascript
// IndexedDB 저장
async function saveOfflineCheckIn(isSober) {
    const db = await openDB('drinky', 1, {
        upgrade(db) {
            db.createObjectStore('offlineCheckins', { keyPath: 'id', autoIncrement: true });
        }
    });

    await db.add('offlineCheckins', {
        isSober,
        date: new Date().toISOString(),
        synced: false
    });
}

// Background Sync 등록
async function registerSync() {
    const registration = await navigator.serviceWorker.ready;
    await registration.sync.register('sync-checkins');
}

// Service Worker에서 동기화 처리
self.addEventListener('sync', (event) => {
    if (event.tag === 'sync-checkins') {
        event.waitUntil(syncOfflineCheckins());
    }
});

async function syncOfflineCheckins() {
    const db = await openDB('drinky', 1);
    const checkins = await db.getAll('offlineCheckins');

    for (const checkin of checkins) {
        if (!checkin.synced) {
            try {
                await fetch('/checkin', {
                    method: 'POST',
                    body: JSON.stringify(checkin),
                    headers: { 'Content-Type': 'application/json' }
                });
                checkin.synced = true;
                await db.put('offlineCheckins', checkin);
            } catch (e) {
                console.error('Sync failed', e);
            }
        }
    }
}
```

### Lighthouse 체크리스트

| 항목 | 요구사항 |
|------|----------|
| **Performance** | FCP < 1.8s, LCP < 2.5s, CLS < 0.1 |
| **PWA** | manifest.json, service-worker, HTTPS, 오프라인 지원 |
| **Accessibility** | 색상 대비, 터치 타겟, ARIA 레이블 |
| **Best Practices** | HTTPS, 콘솔 에러 없음, 취약 라이브러리 없음 |
| **SEO** | 메타 태그, robots.txt, 모바일 친화적 |

---

## Testing

### 이 스토리의 테스트 요구사항

| 테스트 유형 | 테스트 내용 |
|------------|------------|
| **수동 테스트** | 홈 화면 추가, 오프라인 동작, 푸시 알림 |
| **Lighthouse** | 각 카테고리 90점 이상 |
| **크로스 브라우저** | Chrome, Safari, Samsung Internet |

### 테스트 시나리오

1. **홈 화면 추가**
   - Android Chrome: 프롬프트 표시 및 설치
   - iOS Safari: 수동 추가 안내 배너 표시

2. **오프라인 모드**
   - 네트워크 끊김 상태에서 앱 실행
   - 오프라인에서 체크인 시도 → 로컬 저장
   - 네트워크 복귀 시 자동 동기화

3. **성능**
   - 첫 로딩 3초 이내
   - 체크인 인터랙션 100ms 이내

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | 스토리 초안 작성 | PO Sarah |

---

## Dev Agent Record

*(개발 에이전트가 구현 시 기록)*

---

## QA Results

*(QA 에이전트의 리뷰 결과)*
