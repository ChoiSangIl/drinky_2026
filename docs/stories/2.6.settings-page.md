# Story 2.6: ì„¤ì • í™”ë©´

## Status

**Draft**

---

## Story

**As a** ì‚¬ìš©ì,
**I want** ì•Œë¦¼ ì‹œê°„ê³¼ ê³„ì • ì •ë³´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ì„œ,
**so that** ì•±ì„ ë‚˜ì—ê²Œ ë§ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ ìˆë‹¤.

---

## Acceptance Criteria

1. ì„¤ì • íƒ­/í˜ì´ì§€ ìƒì„± ë° ë„¤ë¹„ê²Œì´ì…˜ ì—°ê²°
2. ì•Œë¦¼ ì„¤ì • ì„¹ì…˜:
   - í‘¸ì‹œ ì•Œë¦¼ ON/OFF í† ê¸€
   - ì•Œë¦¼ ì‹œê°„ ì„ íƒ (ì‹œê°„ í”¼ì»¤)
3. ê³„ì • ì„¤ì • ì„¹ì…˜:
   - ë‹‰ë„¤ì„ ìˆ˜ì •
   - ì´ë©”ì¼ í‘œì‹œ (ì½ê¸° ì „ìš©)
   - ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
4. ì•± ì •ë³´ ì„¹ì…˜:
   - ë²„ì „ ì •ë³´
   - ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë§í¬
   - ë¬¸ì˜í•˜ê¸° (ì´ë©”ì¼ ë§í¬)
5. ê³„ì • ì‚­ì œ ê¸°ëŠ¥ (í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í•„ìˆ˜)
6. ì„¤ì • ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥

---

## Tasks / Subtasks

- [ ] **Task 1: ì„¤ì • í˜ì´ì§€ ë ˆì´ì•„ì›ƒ** (AC: 1)
  - [ ] `templates/pages/settings.html` ìƒì„±
  - [ ] ì„¹ì…˜ë³„ êµ¬ë¶„ (ì•Œë¦¼, ê³„ì •, ì•± ì •ë³´)
  - [ ] í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”

- [ ] **Task 2: SettingsController êµ¬í˜„** (AC: 1)
  - [ ] `SettingsController.kt` ìƒì„±
  - [ ] `GET /settings` - ì„¤ì • í˜ì´ì§€
  - [ ] í˜„ì¬ ì„¤ì •ê°’ Modelì— ì¶”ê°€

- [ ] **Task 3: ì•Œë¦¼ ì„¤ì • UI** (AC: 2, 6)
  - [ ] ì•Œë¦¼ ON/OFF í† ê¸€ ìŠ¤ìœ„ì¹˜
  - [ ] HTMXë¡œ ì¦‰ì‹œ ì €ì¥
    ```html
    hx-post="/settings/notification/toggle"
    hx-swap="none"
    ```
  - [ ] ì•Œë¦¼ ì‹œê°„ ì„ íƒ (ì‹œê°„ í”¼ì»¤)
  - [ ] ì‹œê°„ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥

- [ ] **Task 4: NotificationSettingsController** (AC: 2)
  - [ ] `POST /settings/notification/toggle` - ì•Œë¦¼ ON/OFF
  - [ ] `POST /settings/notification/time` - ì‹œê°„ ë³€ê²½
  - [ ] PushSubscription ì—…ë°ì´íŠ¸

- [ ] **Task 5: ê³„ì • ì„¤ì • UI** (AC: 3)
  - [ ] í”„ë¡œí•„ ì˜ì—­ (ì•„ë°”íƒ€, ë‹‰ë„¤ì„, ì´ë©”ì¼)
  - [ ] ë‹‰ë„¤ì„ ìˆ˜ì • ë²„íŠ¼ â†’ ì¸ë¼ì¸ ì—ë””íŠ¸
  - [ ] ì´ë©”ì¼ í‘œì‹œ (ì½ê¸° ì „ìš©)
  - [ ] ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼

- [ ] **Task 6: ë‹‰ë„¤ì„ ìˆ˜ì • ê¸°ëŠ¥** (AC: 3, 6)
  - [ ] `POST /settings/nickname` - ë‹‰ë„¤ì„ ë³€ê²½
  - [ ] ìœ íš¨ì„± ê²€ì‚¬ (2-20ì, íŠ¹ìˆ˜ë¬¸ì ì œí•œ)
  - [ ] HTMXë¡œ ì¦‰ì‹œ ì €ì¥ ë° UI ì—…ë°ì´íŠ¸

- [ ] **Task 7: ì•± ì •ë³´ ì„¹ì…˜** (AC: 4)
  - [ ] ë²„ì „ ì •ë³´ í‘œì‹œ (application.ymlì—ì„œ ì½ê¸°)
  - [ ] ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë§í¬
  - [ ] ë¬¸ì˜í•˜ê¸° (mailto: ë§í¬)

- [ ] **Task 8: ê³„ì • ì‚­ì œ ê¸°ëŠ¥** (AC: 5)
  - [ ] "ê³„ì • ì‚­ì œ" ë²„íŠ¼
  - [ ] í™•ì¸ ëª¨ë‹¬ (2ë‹¨ê³„ í™•ì¸)
    - [ ] 1ë‹¨ê³„: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
    - [ ] 2ë‹¨ê³„: "ì‚­ì œ" ì…ë ¥ í›„ í™•ì¸
  - [ ] `DELETE /settings/account` - ê³„ì • ì‚­ì œ API
  - [ ] ëª¨ë“  ë°ì´í„° ì‚­ì œ (CASCADE)
  - [ ] ë¡œê·¸ì•„ì›ƒ í›„ ì˜¨ë³´ë”©ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

- [ ] **Task 9: í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸**
  - [ ] ì„¤ì • íƒ­ í™œì„±í™” (pointer-events ì œê±°)
  - [ ] currentPage íŒŒë¼ë¯¸í„°ë¡œ í•˜ì´ë¼ì´íŠ¸

---

## Dev Notes

### í”„ë¡œì íŠ¸ êµ¬ì¡° (ì´ ìŠ¤í† ë¦¬ ê´€ë ¨)

```
src/main/kotlin/com/drinky/
â””â”€â”€ controller/
    â””â”€â”€ SettingsController.kt

src/main/resources/templates/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ settings.html
â””â”€â”€ fragments/
    â”œâ”€â”€ settings-notification.html
    â”œâ”€â”€ settings-account.html
    â””â”€â”€ settings-delete-modal.html
```

### ì„¤ì • í˜ì´ì§€ ì˜ˆì‹œ

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>ì„¤ì •</title>
</head>
<body>
<div layout:fragment="content" class="px-4 py-6">

    <h1 class="text-2xl font-bold text-gray-800 mb-6">ì„¤ì •</h1>

    <!-- ì•Œë¦¼ ì„¤ì • -->
    <section class="bg-white rounded-xl shadow-sm p-4 mb-4">
        <h2 class="font-semibold text-gray-700 mb-4">ğŸ”” ì•Œë¦¼</h2>

        <!-- ì•Œë¦¼ ON/OFF -->
        <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <span class="text-gray-600">í‘¸ì‹œ ì•Œë¦¼</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox"
                       th:checked="${notificationEnabled}"
                       hx-post="/settings/notification/toggle"
                       hx-swap="none"
                       class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
            </label>
        </div>

        <!-- ì•Œë¦¼ ì‹œê°„ -->
        <div class="flex items-center justify-between py-3">
            <span class="text-gray-600">ì•Œë¦¼ ì‹œê°„</span>
            <select th:value="${preferredTime}"
                    hx-post="/settings/notification/time"
                    hx-swap="none"
                    name="time"
                    class="bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-3 py-2">
                <option value="18:00" th:selected="${preferredTime == '18:00'}">ì˜¤í›„ 6ì‹œ</option>
                <option value="19:00" th:selected="${preferredTime == '19:00'}">ì˜¤í›„ 7ì‹œ</option>
                <option value="20:00" th:selected="${preferredTime == '20:00'}">ì˜¤í›„ 8ì‹œ</option>
                <option value="21:00" th:selected="${preferredTime == '21:00'}">ì˜¤í›„ 9ì‹œ</option>
                <option value="22:00" th:selected="${preferredTime == '22:00'}">ì˜¤í›„ 10ì‹œ</option>
            </select>
        </div>
    </section>

    <!-- ê³„ì • ì„¤ì • -->
    <section class="bg-white rounded-xl shadow-sm p-4 mb-4">
        <h2 class="font-semibold text-gray-700 mb-4">ğŸ‘¤ ê³„ì •</h2>

        <!-- í”„ë¡œí•„ -->
        <div class="flex items-center gap-4 py-3 border-b border-gray-100">
            <img th:src="${user.profileImage ?: '/icons/default-avatar.png'}"
                 class="w-12 h-12 rounded-full" alt="í”„ë¡œí•„">
            <div>
                <div x-data="{ editing: false }" class="flex items-center gap-2">
                    <span x-show="!editing" th:text="${user.nickname}" class="font-medium text-gray-800">ë‹‰ë„¤ì„</span>
                    <button x-show="!editing" @click="editing = true" class="text-emerald-500 text-sm">ìˆ˜ì •</button>

                    <form x-show="editing"
                          hx-post="/settings/nickname"
                          hx-swap="outerHTML"
                          class="flex items-center gap-2">
                        <input type="text" name="nickname" th:value="${user.nickname}"
                               class="border rounded px-2 py-1 text-sm w-32">
                        <button type="submit" class="text-emerald-500 text-sm">ì €ì¥</button>
                        <button type="button" @click="editing = false" class="text-gray-400 text-sm">ì·¨ì†Œ</button>
                    </form>
                </div>
                <p class="text-sm text-gray-400" th:text="${user.email}">email@example.com</p>
            </div>
        </div>

        <!-- ë¡œê·¸ì•„ì›ƒ -->
        <form th:action="@{/logout}" method="post" class="py-3">
            <button type="submit" class="text-red-500">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
    </section>

    <!-- ì•± ì •ë³´ -->
    <section class="bg-white rounded-xl shadow-sm p-4 mb-4">
        <h2 class="font-semibold text-gray-700 mb-4">â„¹ï¸ ì•± ì •ë³´</h2>

        <div class="space-y-3 text-gray-600">
            <div class="flex justify-between">
                <span>ë²„ì „</span>
                <span class="text-gray-400" th:text="${appVersion}">1.0.0</span>
            </div>
            <a href="/privacy" class="block py-2">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
            <a href="mailto:support@drinky.app" class="block py-2">ë¬¸ì˜í•˜ê¸°</a>
        </div>
    </section>

    <!-- ê³„ì • ì‚­ì œ -->
    <section class="text-center py-4">
        <button @click="$refs.deleteModal.showModal()"
                class="text-sm text-gray-400 underline">
            ê³„ì • ì‚­ì œ
        </button>
    </section>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <dialog x-ref="deleteModal" class="rounded-xl p-6 backdrop:bg-black/50">
        <div x-data="{ step: 1, confirmText: '' }">
            <!-- Step 1 -->
            <div x-show="step === 1" class="text-center">
                <h3 class="text-lg font-bold text-gray-800 mb-2">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
                <p class="text-gray-500 text-sm mb-4">ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
                <div class="flex gap-2">
                    <button @click="$refs.deleteModal.close()" class="flex-1 py-2 border rounded-lg">ì·¨ì†Œ</button>
                    <button @click="step = 2" class="flex-1 py-2 bg-red-500 text-white rounded-lg">ë‹¤ìŒ</button>
                </div>
            </div>

            <!-- Step 2 -->
            <div x-show="step === 2" class="text-center">
                <h3 class="text-lg font-bold text-gray-800 mb-2">ìµœì¢… í™•ì¸</h3>
                <p class="text-gray-500 text-sm mb-4">"ì‚­ì œ"ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                <input type="text" x-model="confirmText"
                       class="border rounded-lg px-3 py-2 w-full mb-4" placeholder="ì‚­ì œ">
                <div class="flex gap-2">
                    <button @click="step = 1" class="flex-1 py-2 border rounded-lg">ì´ì „</button>
                    <form th:action="@{/settings/account}" method="post">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit"
                                :disabled="confirmText !== 'ì‚­ì œ'"
                                class="flex-1 py-2 bg-red-500 text-white rounded-lg disabled:opacity-50">
                            ì‚­ì œí•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </dialog>

</div>
</body>
</html>
```

### SettingsController ì˜ˆì‹œ

```kotlin
@Controller
class SettingsController(
    private val userService: UserService,
    private val pushSubscriptionRepository: PushSubscriptionRepository
) {
    @Value("\${app.version}")
    private lateinit var appVersion: String

    @GetMapping("/settings")
    fun settings(model: Model, @AuthenticationPrincipal principal: UserPrincipal): String {
        val user = userService.findById(principal.userId)
        val subscription = pushSubscriptionRepository.findFirstByUserIdAndIsActive(principal.userId, true)

        model.addAttribute("user", user)
        model.addAttribute("notificationEnabled", subscription?.isActive ?: false)
        model.addAttribute("preferredTime", subscription?.preferredTime ?: LocalTime.of(21, 0))
        model.addAttribute("appVersion", appVersion)
        model.addAttribute("currentPage", "settings")

        return "pages/settings"
    }

    @PostMapping("/settings/notification/toggle")
    @ResponseBody
    fun toggleNotification(@AuthenticationPrincipal principal: UserPrincipal): ResponseEntity<Void> {
        pushSubscriptionRepository.findFirstByUserIdAndIsActive(principal.userId, true)?.let {
            it.isActive = !it.isActive
            pushSubscriptionRepository.save(it)
        }
        return ResponseEntity.ok().build()
    }

    @PostMapping("/settings/notification/time")
    @ResponseBody
    fun updateNotificationTime(
        @RequestParam time: String,
        @AuthenticationPrincipal principal: UserPrincipal
    ): ResponseEntity<Void> {
        pushSubscriptionRepository.findFirstByUserIdAndIsActive(principal.userId, true)?.let {
            it.preferredTime = LocalTime.parse(time)
            pushSubscriptionRepository.save(it)
        }
        return ResponseEntity.ok().build()
    }

    @PostMapping("/settings/nickname")
    fun updateNickname(
        @RequestParam nickname: String,
        @AuthenticationPrincipal principal: UserPrincipal,
        model: Model
    ): String {
        val user = userService.updateNickname(principal.userId, nickname)
        model.addAttribute("user", user)
        return "fragments/settings-nickname :: content"
    }

    @DeleteMapping("/settings/account")
    fun deleteAccount(@AuthenticationPrincipal principal: UserPrincipal): String {
        userService.deleteAccount(principal.userId)
        return "redirect:/logout"
    }
}
```

---

## Testing

### ì´ ìŠ¤í† ë¦¬ì˜ í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­

| í…ŒìŠ¤íŠ¸ íŒŒì¼ | í…ŒìŠ¤íŠ¸ ë‚´ìš© |
|------------|------------|
| `SettingsControllerTest.kt` | ì„¤ì • í˜ì´ì§€ ë Œë”ë§, ì„¤ì • ë³€ê²½ API |
| `UserServiceTest.kt` | ë‹‰ë„¤ì„ ë³€ê²½, ê³„ì • ì‚­ì œ ë¡œì§ |

### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

1. ì„¤ì • í˜ì´ì§€ ì •ìƒ ë Œë”ë§
2. ì•Œë¦¼ í† ê¸€ ON/OFF
3. ì•Œë¦¼ ì‹œê°„ ë³€ê²½
4. ë‹‰ë„¤ì„ ë³€ê²½ (ìœ íš¨ì„± ê²€ì‚¬ í¬í•¨)
5. ê³„ì • ì‚­ì œ ì‹œ ëª¨ë“  ë°ì´í„° ì‚­ì œ

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | ìŠ¤í† ë¦¬ ì´ˆì•ˆ ì‘ì„± | PO Sarah |

---

## Dev Agent Record

*(ê°œë°œ ì—ì´ì „íŠ¸ê°€ êµ¬í˜„ ì‹œ ê¸°ë¡)*

---

## QA Results

*(QA ì—ì´ì „íŠ¸ì˜ ë¦¬ë·° ê²°ê³¼)*
