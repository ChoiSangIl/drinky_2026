# Story 2.5: í‘¸ì‹œ ì•Œë¦¼ ìŠ¤ì¼€ì¤„ë§ ë° ì½˜í…ì¸ 

## Status

**Draft**

---

## Story

**As a** ì‚¬ìš©ì,
**I want** ë§¤ì¼ ì„¤ì •í•œ ì‹œê°„ì— ê²©ë ¤ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆì–´ì„œ,
**so that** ìŠì§€ ì•Šê³  ì²´í¬ì¸í•˜ê³  ë™ê¸°ë¶€ì—¬ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.

---

## Acceptance Criteria

1. Spring @Scheduledë¥¼ í™œìš©í•œ ì•Œë¦¼ ìŠ¤ì¼€ì¤„ë§ (ë§¤ë¶„ ì‹¤í–‰, preferred_time ì²´í¬)
2. ê¸°ë³¸ ì•Œë¦¼ ì‹œê°„ ì„¤ì • (ì €ë… 9ì‹œ)
3. ê²©ë ¤ ë©”ì‹œì§€ í…œí”Œë¦¿ (ìµœì†Œ 10ì¢…):
   - "ì˜¤ëŠ˜ í•˜ë£¨ë„ ê³ ìƒí–ˆì–´ìš”! ì²´í¬ì¸ í•´ë³¼ê¹Œìš”?"
   - "ğŸ”¥ {N}ì¼ ì—°ì† ì„±ê³µ ì¤‘! ì˜¤ëŠ˜ë„ í™”ì´íŒ…!"
   - "ê±´ê°•í•œ ì„ íƒì´ ìŒ“ì´ê³  ìˆì–´ìš” ğŸ’ª"
4. ìŠ¤íŠ¸ë¦­ ê¸°ë°˜ ë©”ì‹œì§€ ë¶„ê¸° (ìŠ¤íŠ¸ë¦­ 0ì¼ vs 7ì¼+)
5. ì˜¤ëŠ˜ ì´ë¯¸ ì²´í¬ì¸í•œ ê²½ìš° ë‹¤ë¥¸ ë©”ì‹œì§€ ("ì˜¤ëŠ˜ë„ ê¸°ë¡ ì™„ë£Œ! ëŒ€ë‹¨í•´ìš”")
6. ì•Œë¦¼ ë°œì†¡ ë¡œê·¸ ì €ì¥

---

## Tasks / Subtasks

- [ ] **Task 1: PushScheduler êµ¬í˜„** (AC: 1)
  - [ ] `scheduler/PushScheduler.kt` ìƒì„±
  - [ ] `@Scheduled(cron = "0 * * * * *")` - ë§¤ë¶„ ì‹¤í–‰
  - [ ] í˜„ì¬ ì‹œê°„(ë¶„ ë‹¨ìœ„)ì— í•´ë‹¹í•˜ëŠ” êµ¬ë…ì ì¡°íšŒ
  - [ ] ë°°ì¹˜ ë°œì†¡ ì²˜ë¦¬

- [ ] **Task 2: ì•Œë¦¼ ëŒ€ìƒ ì¡°íšŒ ì¿¼ë¦¬** (AC: 1)
  - [ ] `PushSubscriptionRepository`ì— ì¿¼ë¦¬ ì¶”ê°€
    ```kotlin
    @Query("SELECT p FROM PushSubscription p WHERE p.preferredTime = :time AND p.isActive = true")
    fun findByPreferredTimeAndActive(time: LocalTime): List<PushSubscription>
    ```

- [ ] **Task 3: ë©”ì‹œì§€ í…œí”Œë¦¿ ì‹œìŠ¤í…œ** (AC: 3, 4)
  - [ ] `PushMessageTemplates.kt` ìƒì„±
  - [ ] ê¸°ë³¸ ë©”ì‹œì§€ (10ì¢… ì´ìƒ)
  - [ ] ìŠ¤íŠ¸ë¦­ ê¸°ë°˜ ë©”ì‹œì§€ ë¶„ê¸°
    - [ ] 0ì¼: ì‹œì‘ ë…ë ¤ ë©”ì‹œì§€
    - [ ] 1-6ì¼: ì´ˆë°˜ ê²©ë ¤
    - [ ] 7-13ì¼: ì£¼ê°„ ë‹¬ì„± ì¶•í•˜
    - [ ] 14ì¼+: ì¥ê¸° ì„±ê³µ ì¹­ì°¬
  - [ ] ë©”ì‹œì§€ ëœë¤ ì„ íƒ ë¡œì§

- [ ] **Task 4: ì²´í¬ì¸ ìƒíƒœ í™•ì¸** (AC: 5)
  - [ ] ì•Œë¦¼ ë°œì†¡ ì „ ì˜¤ëŠ˜ ì²´í¬ì¸ ì—¬ë¶€ í™•ì¸
  - [ ] ì²´í¬ì¸ ì™„ë£Œ ì‹œ ë‹¤ë¥¸ ë©”ì‹œì§€ ë°œì†¡
  - [ ] ì²´í¬ì¸ ë¯¸ì™„ë£Œ ì‹œ ì²´í¬ì¸ ë…ë ¤ ë©”ì‹œì§€

- [ ] **Task 5: PushService ë°œì†¡ ë¡œì§ í™•ì¥** (AC: 1, 6)
  - [ ] `sendScheduledNotification(subscription, message)` ë©”ì„œë“œ
  - [ ] ë°œì†¡ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ (ì„ íƒ)
  - [ ] í† í° ë¬´íš¨í™” ì‹œ êµ¬ë… ë¹„í™œì„±í™”

- [ ] **Task 6: ì•Œë¦¼ ë¡œê·¸ í…Œì´ë¸”** (AC: 6)
  - [ ] `V5__create_notification_logs.sql` (ì„ íƒì‚¬í•­)
    ```sql
    CREATE TABLE notification_logs (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL REFERENCES users(id),
        message_type VARCHAR(50) NOT NULL,
        status VARCHAR(20) NOT NULL,
        sent_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    ```
  - [ ] `NotificationLog` ì—”í‹°í‹° ìƒì„±
  - [ ] ë°œì†¡ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê¹…

- [ ] **Task 7: ì„¤ì • í˜ì´ì§€ ì—°ë™ ì¤€ë¹„** (AC: 2)
  - [ ] ê¸°ë³¸ preferred_time: 21:00 (ì €ë… 9ì‹œ)
  - [ ] ì‹œê°„ ë³€ê²½ API ì¤€ë¹„ (Story 2.6ì—ì„œ UI êµ¬í˜„)

---

## Dev Notes

### í”„ë¡œì íŠ¸ êµ¬ì¡° (ì´ ìŠ¤í† ë¦¬ ê´€ë ¨)

```
src/main/kotlin/com/drinky/
â”œâ”€â”€ scheduler/
â”‚   â””â”€â”€ PushScheduler.kt
â”œâ”€â”€ service/
â”‚   â””â”€â”€ PushService.kt (í™•ì¥)
â””â”€â”€ util/
    â””â”€â”€ PushMessageTemplates.kt

src/main/resources/db/migration/
â””â”€â”€ V5__create_notification_logs.sql (ì„ íƒ)
```

### PushScheduler ì˜ˆì‹œ

```kotlin
@Component
class PushScheduler(
    private val pushSubscriptionRepository: PushSubscriptionRepository,
    private val checkInService: CheckInService,
    private val streakService: StreakService,
    private val pushService: PushService
) {
    private val logger = LoggerFactory.getLogger(PushScheduler::class.java)

    @Scheduled(cron = "0 * * * * *") // ë§¤ë¶„ ì‹¤í–‰
    fun sendScheduledNotifications() {
        val currentTime = LocalTime.now().withSecond(0).withNano(0)
        val subscriptions = pushSubscriptionRepository.findByPreferredTimeAndActive(currentTime)

        logger.info("Sending notifications for ${subscriptions.size} users at $currentTime")

        subscriptions.forEach { subscription ->
            try {
                sendNotificationToUser(subscription)
            } catch (e: Exception) {
                logger.error("Failed to send notification to user ${subscription.userId}", e)
            }
        }
    }

    private fun sendNotificationToUser(subscription: PushSubscription) {
        val userId = subscription.userId
        val todayCheckIn = checkInService.getTodayCheckIn(userId)
        val streak = streakService.getOrCreateStreak(userId)

        val (title, body) = if (todayCheckIn != null) {
            // ì´ë¯¸ ì²´í¬ì¸ ì™„ë£Œ
            PushMessageTemplates.getCompletedMessage(streak.currentStreak)
        } else {
            // ì²´í¬ì¸ ë…ë ¤
            PushMessageTemplates.getReminderMessage(streak.currentStreak)
        }

        pushService.sendNotification(subscription.fcmToken, title, body)
    }
}
```

### ë©”ì‹œì§€ í…œí”Œë¦¿ ì˜ˆì‹œ

```kotlin
object PushMessageTemplates {

    // ì²´í¬ì¸ ë…ë ¤ ë©”ì‹œì§€ (ë¯¸ì™„ë£Œ ì‚¬ìš©ììš©)
    private val reminderMessages = mapOf(
        "new" to listOf(
            Pair("Drinky", "ì˜¤ëŠ˜ í•˜ë£¨ë„ ê³ ìƒí–ˆì–´ìš”! ì²´í¬ì¸ í•´ë³¼ê¹Œìš”? ğŸ’ª"),
            Pair("Drinky", "ì˜¤ëŠ˜ì˜ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš” ğŸ“"),
            Pair("Drinky", "ì ê¹! ì˜¤ëŠ˜ ì²´í¬ì¸ í•˜ì…¨ë‚˜ìš”? ğŸ¤”")
        ),
        "streak" to listOf(
            Pair("ğŸ”¥ ìŠ¤íŠ¸ë¦­ ì§„í–‰ ì¤‘!", "{N}ì¼ ì—°ì† ì„±ê³µ ì¤‘! ì˜¤ëŠ˜ë„ ì´ì–´ê°€ìš”!"),
            Pair("Drinky", "ì—°ì† {N}ì¼ì§¸! ì˜¤ëŠ˜ë„ í™”ì´íŒ…! ğŸ’ª"),
            Pair("Drinky", "ëŒ€ë‹¨í•´ìš”! {N}ì¼ ì—°ì†! ì˜¤ëŠ˜ ì²´í¬ì¸ë„ ìŠì§€ ë§ˆì„¸ìš” âœ¨")
        ),
        "milestone" to listOf(
            Pair("ğŸ† ì¼ì£¼ì¼ ëŒíŒŒ!", "7ì¼ ì—°ì† ì„±ê³µ! ì˜¤ëŠ˜ë„ ê¸°ë¡í•´ë³¼ê¹Œìš”?"),
            Pair("ğŸ‰ 2ì£¼ ë‹¬ì„±!", "14ì¼ì´ë‚˜ ì—°ì†! ì •ë§ ëŒ€ë‹¨í•´ìš”!"),
            Pair("ğŸ‘‘ í•œ ë‹¬ì˜ ê¸°ì !", "30ì¼ ì—°ì†! ë‹¹ì‹ ì€ ì§„ì •í•œ ì±”í”¼ì–¸!")
        )
    )

    // ì²´í¬ì¸ ì™„ë£Œ ë©”ì‹œì§€ (ì´ë¯¸ ì²´í¬ì¸í•œ ì‚¬ìš©ììš©)
    private val completedMessages = listOf(
        Pair("ì˜¤ëŠ˜ë„ ê¸°ë¡ ì™„ë£Œ! ğŸ‘", "ê¾¸ì¤€í•¨ì´ ë¹›ë‚˜ìš”. ë‚´ì¼ë„ í™”ì´íŒ…!"),
        Pair("ì˜í•˜ê³  ìˆì–´ìš”! âœ¨", "ì˜¤ëŠ˜ì˜ ì²´í¬ì¸ ì™„ë£Œ! í‘¹ ì‰¬ì„¸ìš” ğŸ˜Š"),
        Pair("ëŒ€ë‹¨í•´ìš”! ğŸŒŸ", "ì˜¤ëŠ˜ë„ ê±´ê°•í•œ ì„ íƒì„ í–ˆë„¤ìš”!")
    )

    fun getReminderMessage(currentStreak: Int): Pair<String, String> {
        return when {
            currentStreak == 0 -> reminderMessages["new"]!!.random()
            currentStreak == 7 || currentStreak == 14 || currentStreak == 30 ->
                reminderMessages["milestone"]!!
                    .random()
                    .let { Pair(it.first, it.second.replace("{N}", currentStreak.toString())) }
            currentStreak > 0 ->
                reminderMessages["streak"]!!
                    .random()
                    .let { Pair(it.first, it.second.replace("{N}", currentStreak.toString())) }
            else -> reminderMessages["new"]!!.random()
        }
    }

    fun getCompletedMessage(currentStreak: Int): Pair<String, String> {
        val base = completedMessages.random()
        return if (currentStreak > 7) {
            Pair("${currentStreak}ì¼ ì—°ì†! ${base.first}", base.second)
        } else {
            base
        }
    }
}
```

### ì•Œë¦¼ ë°œì†¡ íë¦„

```mermaid
sequenceDiagram
    participant Scheduler as PushScheduler
    participant Repo as PushSubscriptionRepo
    participant CheckIn as CheckInService
    participant Streak as StreakService
    participant Push as PushService
    participant FCM as Firebase CM

    Note over Scheduler: ë§¤ë¶„ 0ì´ˆì— ì‹¤í–‰

    Scheduler->>Repo: í˜„ì¬ ì‹œê°„ êµ¬ë…ì ì¡°íšŒ
    Repo-->>Scheduler: êµ¬ë…ì ëª©ë¡

    loop ê° êµ¬ë…ì
        Scheduler->>CheckIn: ì˜¤ëŠ˜ ì²´í¬ì¸ í™•ì¸
        CheckIn-->>Scheduler: ì²´í¬ì¸ ì—¬ë¶€

        Scheduler->>Streak: í˜„ì¬ ìŠ¤íŠ¸ë¦­ ì¡°íšŒ
        Streak-->>Scheduler: ìŠ¤íŠ¸ë¦­ ì •ë³´

        Note over Scheduler: ë©”ì‹œì§€ ì„ íƒ<br/>(ì²´í¬ì¸ ì—¬ë¶€ + ìŠ¤íŠ¸ë¦­ ê¸°ë°˜)

        Scheduler->>Push: ì•Œë¦¼ ë°œì†¡
        Push->>FCM: í‘¸ì‹œ ë©”ì‹œì§€ ì „ì†¡
        FCM-->>Push: ì„±ê³µ/ì‹¤íŒ¨
    end
```

### í…ŒìŠ¤íŠ¸ìš© ìˆ˜ë™ ë°œì†¡ API

```kotlin
@RestController
@RequestMapping("/api/push")
class PushAdminController(
    private val pushScheduler: PushScheduler
) {
    @PostMapping("/trigger")
    @PreAuthorize("hasRole('ADMIN')") // ë˜ëŠ” ê°œë°œ í™˜ê²½ì—ì„œë§Œ
    fun triggerManually(): ResponseEntity<String> {
        pushScheduler.sendScheduledNotifications()
        return ResponseEntity.ok("Triggered")
    }
}
```

---

## Testing

### ì´ ìŠ¤í† ë¦¬ì˜ í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­

| í…ŒìŠ¤íŠ¸ íŒŒì¼ | í…ŒìŠ¤íŠ¸ ë‚´ìš© |
|------------|------------|
| `PushSchedulerTest.kt` | ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§, ì¡°ê±´ë³„ ë©”ì‹œì§€ ì„ íƒ |
| `PushMessageTemplatesTest.kt` | ë©”ì‹œì§€ í…œí”Œë¦¿ ëœë¤ ì„ íƒ, ìŠ¤íŠ¸ë¦­ ì¹˜í™˜ |

### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

1. ì„¤ì • ì‹œê°„ì— ë§ëŠ” êµ¬ë…ìë§Œ ì¡°íšŒ
2. ì²´í¬ì¸ ì™„ë£Œ ì‚¬ìš©ìì—ê²Œ ë‹¤ë¥¸ ë©”ì‹œì§€ ë°œì†¡
3. ìŠ¤íŠ¸ë¦­ 0ì¼/7ì¼+ì— ë”°ë¥¸ ë©”ì‹œì§€ ë¶„ê¸°
4. FCM í† í° ë¬´íš¨í™” ì‹œ êµ¬ë… ë¹„í™œì„±í™”

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | ìŠ¤í† ë¦¬ ì´ˆì•ˆ ì‘ì„± | PO Sarah |

---

## Dev Agent Record

*(ê°œë°œ ì—ì´ì „íŠ¸ê°€ êµ¬í˜„ ì‹œ ê¸°ë¡)*

---

## QA Results

*(QA ì—ì´ì „íŠ¸ì˜ ë¦¬ë·° ê²°ê³¼)*
