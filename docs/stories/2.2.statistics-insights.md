# Story 2.2: ê¸°ë¡ ì°¨íŠ¸ - í†µê³„ ë° ì¸ì‚¬ì´íŠ¸

## Status

**Draft**

---

## Story

**As a** ì‚¬ìš©ì,
**I want** ì£¼ê°„/ì›”ê°„ ìŒì£¼ í†µê³„ë¥¼ ê·¸ë˜í”„ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ì„œ,
**so that** ë‚´ ìŒì£¼ ìŠµê´€ì˜ ì¶”ì„¸ë¥¼ ì´í•´í•˜ê³  ê°œì„ í•  ìˆ˜ ìˆë‹¤.

---

## Acceptance Criteria

1. ì£¼ê°„ ìŒì£¼ íšŸìˆ˜ ë°” ì°¨íŠ¸ (ìµœê·¼ 4ì£¼)
2. ì›”ê°„ ìŒì£¼ íšŸìˆ˜ ì¶”ì´ ê·¸ë˜í”„ (ìµœê·¼ 3ê°œì›”)
3. í•µì‹¬ í†µê³„ ì¹´ë“œ í‘œì‹œ:
   - ì´ë²ˆ ì£¼ ìŒì£¼ íšŸìˆ˜ / ì§€ë‚œ ì£¼ ëŒ€ë¹„
   - ì´ë²ˆ ë‹¬ ìŒì£¼ íšŸìˆ˜ / ì§€ë‚œ ë‹¬ ëŒ€ë¹„
   - í˜„ì¬ ìŠ¤íŠ¸ë¦­ / ìµœì¥ ìŠ¤íŠ¸ë¦­
4. ê¸ì •ì  ì¸ì‚¬ì´íŠ¸ ë©”ì‹œì§€ ("ì§€ë‚œ ì£¼ë³´ë‹¤ 2ì¼ ì¤„ì—ˆì–´ìš”!")
5. ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (Chart.js ë˜ëŠ” ApexCharts - CDN)
6. ë°ì´í„° ì—†ëŠ” ê¸°ê°„ ì²˜ë¦¬ (ë¹ˆ ìƒíƒœ ë©”ì‹œì§€)

---

## Tasks / Subtasks

- [ ] **Task 1: í†µê³„ ë°ì´í„° ì„œë¹„ìŠ¤** (AC: 1, 2, 3)
  - [ ] `StatisticsService.kt` ìƒì„±
  - [ ] `getWeeklyStats(userId: UUID): List<WeeklyStatDto>` - ìµœê·¼ 4ì£¼ í†µê³„
  - [ ] `getMonthlyStats(userId: UUID): List<MonthlyStatDto>` - ìµœê·¼ 3ê°œì›” í†µê³„
  - [ ] `getSummaryStats(userId: UUID): SummaryStatDto` - ìš”ì•½ í†µê³„

- [ ] **Task 2: í†µê³„ DTO ì •ì˜**
  - [ ] `WeeklyStatDto`: ì£¼ì°¨, ìŒì£¼ì¼ìˆ˜, ê¸ˆì£¼ì¼ìˆ˜
  - [ ] `MonthlyStatDto`: ì›”, ìŒì£¼ì¼ìˆ˜, ê¸ˆì£¼ì¼ìˆ˜
  - [ ] `SummaryStatDto`: ì´ë²ˆì£¼/ì§€ë‚œì£¼, ì´ë²ˆë‹¬/ì§€ë‚œë‹¬, ìŠ¤íŠ¸ë¦­

- [ ] **Task 3: í†µê³„ ì»¨íŠ¸ë¡¤ëŸ¬** (AC: 1, 2, 3)
  - [ ] `StatisticsController.kt` ìƒì„±
  - [ ] `GET /statistics` - í†µê³„ í˜ì´ì§€ (ë˜ëŠ” ìº˜ë¦°ë” í˜ì´ì§€ ë‚´ íƒ­)
  - [ ] `GET /statistics/weekly` - ì£¼ê°„ ì°¨íŠ¸ ë°ì´í„° (JSON)
  - [ ] `GET /statistics/monthly` - ì›”ê°„ ì°¨íŠ¸ ë°ì´í„° (JSON)

- [ ] **Task 4: ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •** (AC: 5)
  - [ ] Chart.js CDN ì¶”ê°€ (`base.html`)
  - [ ] ë˜ëŠ” ApexCharts CDN ì¶”ê°€
  - [ ] ì°¨íŠ¸ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

- [ ] **Task 5: ì£¼ê°„ ë°” ì°¨íŠ¸ UI** (AC: 1)
  - [ ] `templates/fragments/weekly-chart.html` ìƒì„±
  - [ ] ìµœê·¼ 4ì£¼ ë°” ì°¨íŠ¸
  - [ ] Xì¶•: ì£¼ì°¨ (1ì£¼ ì „, 2ì£¼ ì „...)
  - [ ] Yì¶•: ìŒì£¼ íšŸìˆ˜ (0-7)
  - [ ] ê¸ˆì£¼/ìŒì£¼ ìƒ‰ìƒ êµ¬ë¶„

- [ ] **Task 6: ì›”ê°„ ì¶”ì´ ê·¸ë˜í”„** (AC: 2)
  - [ ] `templates/fragments/monthly-chart.html` ìƒì„±
  - [ ] ìµœê·¼ 3ê°œì›” ë¼ì¸/ë°” ì°¨íŠ¸
  - [ ] íŠ¸ë Œë“œ ì‹œê°í™”

- [ ] **Task 7: ìš”ì•½ í†µê³„ ì¹´ë“œ** (AC: 3)
  - [ ] `templates/fragments/stats-summary.html` ìƒì„±
  - [ ] ì´ë²ˆ ì£¼ ìŒì£¼ íšŸìˆ˜ ì¹´ë“œ
    - [ ] ì§€ë‚œ ì£¼ ëŒ€ë¹„ ì¦ê° í‘œì‹œ (â†‘/â†“/-)
  - [ ] ì´ë²ˆ ë‹¬ ìŒì£¼ íšŸìˆ˜ ì¹´ë“œ
    - [ ] ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ì¦ê° í‘œì‹œ
  - [ ] ìŠ¤íŠ¸ë¦­ ì¹´ë“œ
    - [ ] í˜„ì¬ / ìµœì¥ í‘œì‹œ

- [ ] **Task 8: ì¸ì‚¬ì´íŠ¸ ë©”ì‹œì§€** (AC: 4)
  - [ ] `InsightMessages.kt` ìƒì„±
  - [ ] í†µê³„ ê¸°ë°˜ ê¸ì •ì  ë©”ì‹œì§€ ìƒì„±
    - [ ] ê°ì†Œ: "ì§€ë‚œ ì£¼ë³´ë‹¤ {n}ì¼ ì¤„ì—ˆì–´ìš”! ğŸ‰"
    - [ ] ìœ ì§€: "ê¾¸ì¤€íˆ ì˜ í•˜ê³  ìˆì–´ìš”! ğŸ’ª"
    - [ ] ì¦ê°€: "ì´ë²ˆ ì£¼ëŠ” ì¡°ê¸ˆ í˜ë“¤ì—ˆë„¤ìš”. ë‹¤ìŒ ì£¼ í™”ì´íŒ…!"
  - [ ] ìŠ¤íŠ¸ë¦­ ê¸°ë°˜ ë©”ì‹œì§€

- [ ] **Task 9: ë¹ˆ ìƒíƒœ ì²˜ë¦¬** (AC: 6)
  - [ ] ë°ì´í„° ì—†ëŠ” ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€
  - [ ] "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. ì˜¤ëŠ˜ë¶€í„° ì‹œì‘í•´ë³¼ê¹Œìš”?"
  - [ ] ì²´í¬ì¸ ìœ ë„ ë²„íŠ¼

- [ ] **Task 10: ìº˜ë¦°ë” í˜ì´ì§€ í†µí•©**
  - [ ] ìº˜ë¦°ë” í˜ì´ì§€ì— í†µê³„ ì„¹ì…˜ ì¶”ê°€
  - [ ] ë˜ëŠ” íƒ­ìœ¼ë¡œ ìº˜ë¦°ë”/í†µê³„ ë¶„ë¦¬

---

## Dev Notes

### í”„ë¡œì íŠ¸ êµ¬ì¡° (ì´ ìŠ¤í† ë¦¬ ê´€ë ¨)

```
src/main/kotlin/com/drinky/
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ StatisticsController.kt
â”œâ”€â”€ service/
â”‚   â””â”€â”€ StatisticsService.kt
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ WeeklyStatDto.kt
â”‚       â”œâ”€â”€ MonthlyStatDto.kt
â”‚       â””â”€â”€ SummaryStatDto.kt
â””â”€â”€ util/
    â””â”€â”€ InsightMessages.kt

src/main/resources/templates/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ calendar.html (ìˆ˜ì •)
â””â”€â”€ fragments/
    â”œâ”€â”€ weekly-chart.html
    â”œâ”€â”€ monthly-chart.html
    â””â”€â”€ stats-summary.html

src/main/resources/static/js/
â””â”€â”€ charts.js
```

### StatisticsService ì˜ˆì‹œ

```kotlin
@Service
class StatisticsService(
    private val checkInRepository: CheckInRepository,
    private val streakRepository: StreakRepository
) {
    fun getWeeklyStats(userId: UUID): List<WeeklyStatDto> {
        val endDate = LocalDate.now()
        val startDate = endDate.minusWeeks(4)

        val checkIns = checkInRepository.findByUserIdAndCheckDateBetween(
            userId, startDate, endDate
        )

        return (0..3).map { weeksAgo ->
            val weekStart = endDate.minusWeeks(weeksAgo.toLong()).with(DayOfWeek.MONDAY)
            val weekEnd = weekStart.plusDays(6)
            val weekCheckIns = checkIns.filter {
                it.checkDate in weekStart..weekEnd
            }
            WeeklyStatDto(
                weekLabel = if (weeksAgo == 0) "ì´ë²ˆ ì£¼" else "${weeksAgo}ì£¼ ì „",
                drinkingDays = weekCheckIns.count { !it.isSober },
                soberDays = weekCheckIns.count { it.isSober }
            )
        }.reversed()
    }

    fun getSummaryStats(userId: UUID): SummaryStatDto {
        val streak = streakRepository.findByUserId(userId)
        val thisWeek = getThisWeekCount(userId)
        val lastWeek = getLastWeekCount(userId)
        val thisMonth = getThisMonthCount(userId)
        val lastMonth = getLastMonthCount(userId)

        return SummaryStatDto(
            thisWeekDrinking = thisWeek,
            lastWeekDrinking = lastWeek,
            weekChange = thisWeek - lastWeek,
            thisMonthDrinking = thisMonth,
            lastMonthDrinking = lastMonth,
            monthChange = thisMonth - lastMonth,
            currentStreak = streak?.currentStreak ?: 0,
            longestStreak = streak?.longestStreak ?: 0
        )
    }
}
```

### DTO ì •ì˜

```kotlin
data class WeeklyStatDto(
    val weekLabel: String,
    val drinkingDays: Int,
    val soberDays: Int
)

data class MonthlyStatDto(
    val monthLabel: String,
    val drinkingDays: Int,
    val soberDays: Int
)

data class SummaryStatDto(
    val thisWeekDrinking: Int,
    val lastWeekDrinking: Int,
    val weekChange: Int,
    val thisMonthDrinking: Int,
    val lastMonthDrinking: Int,
    val monthChange: Int,
    val currentStreak: Int,
    val longestStreak: Int
) {
    val weekTrend: String get() = when {
        weekChange < 0 -> "â†“ ${-weekChange}ì¼ ê°ì†Œ"
        weekChange > 0 -> "â†‘ ${weekChange}ì¼ ì¦ê°€"
        else -> "- ë³€í™” ì—†ìŒ"
    }
}
```

### Chart.js ì°¨íŠ¸ ì˜ˆì‹œ

```html
<div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
    <h3 class="text-lg font-semibold mb-4">ì£¼ê°„ ìŒì£¼ í˜„í™©</h3>
    <canvas id="weeklyChart" height="200"></canvas>
</div>

<script th:inline="javascript">
    const weeklyData = /*[[${weeklyStats}]]*/ [];

    new Chart(document.getElementById('weeklyChart'), {
        type: 'bar',
        data: {
            labels: weeklyData.map(d => d.weekLabel),
            datasets: [{
                label: 'ìŒì£¼',
                data: weeklyData.map(d => d.drinkingDays),
                backgroundColor: '#F97316',
            }, {
                label: 'ê¸ˆì£¼',
                data: weeklyData.map(d => d.soberDays),
                backgroundColor: '#10B981',
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 7 }
            }
        }
    });
</script>
```

### ìš”ì•½ í†µê³„ ì¹´ë“œ UI ì˜ˆì‹œ

```html
<div class="grid grid-cols-2 gap-4 mb-6">
    <!-- ì´ë²ˆ ì£¼ -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
        <p class="text-sm text-gray-500">ì´ë²ˆ ì£¼ ìŒì£¼</p>
        <p class="text-2xl font-bold" th:text="${stats.thisWeekDrinking + 'ì¼'}">2ì¼</p>
        <p th:class="${stats.weekChange < 0 ? 'text-emerald-500' : 'text-orange-500'}"
           class="text-sm" th:text="${stats.weekTrend}">â†“ 1ì¼ ê°ì†Œ</p>
    </div>

    <!-- ì´ë²ˆ ë‹¬ -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
        <p class="text-sm text-gray-500">ì´ë²ˆ ë‹¬ ìŒì£¼</p>
        <p class="text-2xl font-bold" th:text="${stats.thisMonthDrinking + 'ì¼'}">5ì¼</p>
        <p th:class="${stats.monthChange < 0 ? 'text-emerald-500' : 'text-orange-500'}"
           class="text-sm" th:text="${stats.monthTrend}">â†“ 3ì¼ ê°ì†Œ</p>
    </div>
</div>
```

---

## Testing

### ì´ ìŠ¤í† ë¦¬ì˜ í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­

| í…ŒìŠ¤íŠ¸ íŒŒì¼ | í…ŒìŠ¤íŠ¸ ë‚´ìš© |
|------------|------------|
| `StatisticsServiceTest.kt` | ì£¼ê°„/ì›”ê°„ í†µê³„ ê³„ì‚° ë¡œì§ |
| `StatisticsControllerTest.kt` | í†µê³„ API ì‘ë‹µ í…ŒìŠ¤íŠ¸ |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | ìŠ¤í† ë¦¬ ì´ˆì•ˆ ì‘ì„± | PO Sarah |

---

## Dev Agent Record

### Agent Model Used
*(ê°œë°œ ì—ì´ì „íŠ¸ê°€ êµ¬í˜„ ì‹œ ê¸°ë¡)*

### Debug Log References
*(ê°œë°œ ì¤‘ ìƒì„±ëœ ë””ë²„ê·¸ ë¡œê·¸ ì°¸ì¡°)*

### Completion Notes List
*(íƒœìŠ¤í¬ ì™„ë£Œ ë° ì´ìŠˆ ë…¸íŠ¸)*

### File List
*(êµ¬í˜„ ì¤‘ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡)*

---

## QA Results
*(QA ì—ì´ì „íŠ¸ì˜ ë¦¬ë·° ê²°ê³¼)*
