# Story 2.2: 기록 차트 - 통계 및 인사이트

## Status

**Ready for Review**

---

## Story

**As a** 사용자,
**I want** 주간/월간 음주 통계를 그래프로 확인할 수 있어서,
**so that** 내 음주 습관의 추세를 이해하고 개선할 수 있다.

---

## Acceptance Criteria

1. 주간 음주 횟수 바 차트 (최근 4주)
2. 월간 음주 횟수 추이 그래프 (최근 3개월)
3. 핵심 통계 카드 표시:
   - 이번 주 음주 횟수 / 지난 주 대비
   - 이번 달 음주 횟수 / 지난 달 대비
   - 현재 스트릭 / 최장 스트릭
4. 긍정적 인사이트 메시지 ("지난 주보다 2일 줄었어요!")
5. 차트 라이브러리 사용 (Chart.js 또는 ApexCharts - CDN)
6. 데이터 없는 기간 처리 (빈 상태 메시지)

---

## Tasks / Subtasks

- [x] **Task 1: 통계 데이터 서비스** (AC: 1, 2, 3)
  - [x] `StatisticsService.kt` 생성
  - [x] `getWeeklyStats(userId: UUID): List<WeeklyStatDto>` - 최근 4주 통계
  - [x] `getMonthlyStats(userId: UUID): List<MonthlyStatDto>` - 최근 3개월 통계
  - [x] `getSummaryStats(userId: UUID): SummaryStatDto` - 요약 통계

- [x] **Task 2: 통계 DTO 정의**
  - [x] `WeeklyStatDto`: 주차, 음주일수, 금주일수
  - [x] `MonthlyStatDto`: 월, 음주일수, 금주일수
  - [x] `SummaryStatDto`: 이번주/지난주, 이번달/지난달, 스트릭

- [x] **Task 3: 통계 컨트롤러** (AC: 1, 2, 3)
  - [x] `StatisticsController.kt` 생성
  - [x] `GET /statistics` - 통계 페이지 (별도 페이지)
  - [x] `GET /statistics/weekly` - 주간 차트 데이터 (JSON)
  - [x] `GET /statistics/monthly` - 월간 차트 데이터 (JSON)

- [x] **Task 4: 차트 라이브러리 설정** (AC: 5)
  - [x] Chart.js CDN 추가 (statistics.html에 직접 포함)
  - [x] 차트 초기화 스크립트 작성

- [x] **Task 5: 주간 바 차트 UI** (AC: 1)
  - [x] 최근 4주 스택 바 차트
  - [x] X축: 주차 (이번 주, 1주 전...)
  - [x] Y축: 음주 횟수 (0-7)
  - [x] 금주(emerald)/음주(orange) 색상 구분

- [x] **Task 6: 월간 추이 그래프** (AC: 2)
  - [x] 최근 3개월 스택 바 차트
  - [x] 트렌드 시각화

- [x] **Task 7: 요약 통계 카드** (AC: 3)
  - [x] 이번 주 음주 횟수 카드 + 증감 표시
  - [x] 이번 달 음주 횟수 카드 + 증감 표시
  - [x] 스트릭 카드 (현재/최장)

- [x] **Task 8: 인사이트 메시지** (AC: 4)
  - [x] `InsightMessages.kt` 생성
  - [x] 통계/스트릭 기반 긍정적 메시지 생성

- [x] **Task 9: 빈 상태 처리** (AC: 6)
  - [x] 데이터 없는 경우 안내 메시지 + 체크인 유도 버튼

- [x] **Task 10: 네비게이션 통합**
  - [x] 하단 네비에 통계 탭 추가 (설정 탭 대체)

---

## Dev Notes

### 프로젝트 구조 (이 스토리 관련)

```
src/main/kotlin/com/drinky/
├── controller/
│   └── StatisticsController.kt
├── service/
│   └── StatisticsService.kt
├── domain/
│   └── dto/
│       ├── WeeklyStatDto.kt
│       ├── MonthlyStatDto.kt
│       └── SummaryStatDto.kt
└── util/
    └── InsightMessages.kt

src/main/resources/templates/
├── pages/
│   └── calendar.html (수정)
└── fragments/
    ├── weekly-chart.html
    ├── monthly-chart.html
    └── stats-summary.html

src/main/resources/static/js/
└── charts.js
```

### StatisticsService 예시

```kotlin
@Service
class StatisticsService(
    private val checkInRepository: CheckInRepository,
    private val streakRepository: StreakRepository
) {
    fun getWeeklyStats(userId: UUID): List<WeeklyStatDto> {
        val endDate = LocalDate.now()
        val startDate = endDate.minusWeeks(4)

        val checkIns = checkInRepository.findByUserIdAndCheckDateBetween(
            userId, startDate, endDate
        )

        return (0..3).map { weeksAgo ->
            val weekStart = endDate.minusWeeks(weeksAgo.toLong()).with(DayOfWeek.MONDAY)
            val weekEnd = weekStart.plusDays(6)
            val weekCheckIns = checkIns.filter {
                it.checkDate in weekStart..weekEnd
            }
            WeeklyStatDto(
                weekLabel = if (weeksAgo == 0) "이번 주" else "${weeksAgo}주 전",
                drinkingDays = weekCheckIns.count { !it.isSober },
                soberDays = weekCheckIns.count { it.isSober }
            )
        }.reversed()
    }

    fun getSummaryStats(userId: UUID): SummaryStatDto {
        val streak = streakRepository.findByUserId(userId)
        val thisWeek = getThisWeekCount(userId)
        val lastWeek = getLastWeekCount(userId)
        val thisMonth = getThisMonthCount(userId)
        val lastMonth = getLastMonthCount(userId)

        return SummaryStatDto(
            thisWeekDrinking = thisWeek,
            lastWeekDrinking = lastWeek,
            weekChange = thisWeek - lastWeek,
            thisMonthDrinking = thisMonth,
            lastMonthDrinking = lastMonth,
            monthChange = thisMonth - lastMonth,
            currentStreak = streak?.currentStreak ?: 0,
            longestStreak = streak?.longestStreak ?: 0
        )
    }
}
```

### DTO 정의

```kotlin
data class WeeklyStatDto(
    val weekLabel: String,
    val drinkingDays: Int,
    val soberDays: Int
)

data class MonthlyStatDto(
    val monthLabel: String,
    val drinkingDays: Int,
    val soberDays: Int
)

data class SummaryStatDto(
    val thisWeekDrinking: Int,
    val lastWeekDrinking: Int,
    val weekChange: Int,
    val thisMonthDrinking: Int,
    val lastMonthDrinking: Int,
    val monthChange: Int,
    val currentStreak: Int,
    val longestStreak: Int
) {
    val weekTrend: String get() = when {
        weekChange < 0 -> "↓ ${-weekChange}일 감소"
        weekChange > 0 -> "↑ ${weekChange}일 증가"
        else -> "- 변화 없음"
    }
}
```

### Chart.js 차트 예시

```html
<div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
    <h3 class="text-lg font-semibold mb-4">주간 음주 현황</h3>
    <canvas id="weeklyChart" height="200"></canvas>
</div>

<script th:inline="javascript">
    const weeklyData = /*[[${weeklyStats}]]*/ [];

    new Chart(document.getElementById('weeklyChart'), {
        type: 'bar',
        data: {
            labels: weeklyData.map(d => d.weekLabel),
            datasets: [{
                label: '음주',
                data: weeklyData.map(d => d.drinkingDays),
                backgroundColor: '#F97316',
            }, {
                label: '금주',
                data: weeklyData.map(d => d.soberDays),
                backgroundColor: '#10B981',
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 7 }
            }
        }
    });
</script>
```

### 요약 통계 카드 UI 예시

```html
<div class="grid grid-cols-2 gap-4 mb-6">
    <!-- 이번 주 -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
        <p class="text-sm text-gray-500">이번 주 음주</p>
        <p class="text-2xl font-bold" th:text="${stats.thisWeekDrinking + '일'}">2일</p>
        <p th:class="${stats.weekChange < 0 ? 'text-emerald-500' : 'text-orange-500'}"
           class="text-sm" th:text="${stats.weekTrend}">↓ 1일 감소</p>
    </div>

    <!-- 이번 달 -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
        <p class="text-sm text-gray-500">이번 달 음주</p>
        <p class="text-2xl font-bold" th:text="${stats.thisMonthDrinking + '일'}">5일</p>
        <p th:class="${stats.monthChange < 0 ? 'text-emerald-500' : 'text-orange-500'}"
           class="text-sm" th:text="${stats.monthTrend}">↓ 3일 감소</p>
    </div>
</div>
```

---

## Testing

### 이 스토리의 테스트 요구사항

| 테스트 파일 | 테스트 내용 |
|------------|------------|
| `StatisticsServiceTest.kt` | 주간/월간 통계 계산 로직 |
| `StatisticsControllerTest.kt` | 통계 API 응답 테스트 |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | 스토리 초안 작성 | PO Sarah |
| 2026-02-19 | 0.2 | 전체 구현 완료 (통계 서비스, Chart.js 차트, 인사이트 메시지, 테스트) | Dev James |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
*(없음)*

### Completion Notes List
- **Task 1-3**: StatisticsService에서 주간/월간/요약 통계 계산. CheckInRepository의 기존 `findByUserIdAndCheckDateBetween` 활용.
- **Task 4-6**: Chart.js 4.4.1 CDN 사용. 별도 fragment 대신 statistics.html에 inline으로 차트 구현. Stacked bar chart 사용.
- **Task 7**: 3열 그리드로 요약 카드 (이번 주/이번 달/스트릭). 증감에 따라 emerald/orange 색상 변경.
- **Task 8**: InsightMessages.kt에서 스트릭 우선, 그 다음 주간 변화 기반 메시지 생성.
- **Task 10**: 하단 네비의 설정 탭(비활성)을 통계 탭(활성)으로 교체.

### File List
**신규 생성:**
- `src/main/kotlin/com/drinky/domain/dto/WeeklyStatDto.kt`
- `src/main/kotlin/com/drinky/domain/dto/MonthlyStatDto.kt`
- `src/main/kotlin/com/drinky/domain/dto/SummaryStatDto.kt`
- `src/main/kotlin/com/drinky/service/StatisticsService.kt`
- `src/main/kotlin/com/drinky/controller/StatisticsController.kt`
- `src/main/kotlin/com/drinky/util/InsightMessages.kt`
- `src/main/resources/templates/pages/statistics.html`
- `src/test/kotlin/com/drinky/service/StatisticsServiceTest.kt`
- `src/test/kotlin/com/drinky/controller/StatisticsControllerTest.kt`

**수정:**
- `src/main/resources/templates/fragments/bottom-nav.html` - 통계 탭 추가
- `src/main/resources/static/css/output.css` - TailwindCSS 리빌드

---

## QA Results
*(QA 에이전트의 리뷰 결과)*
