# Story 1.6: ì—°ì† ê¸ˆì£¼ ìŠ¤íŠ¸ë¦­ í‘œì‹œ

## Status

**Ready for Review**

---

## Story

**As a** ì‚¬ìš©ì,
**I want** ì—°ì†ìœ¼ë¡œ ìˆ ì„ ë§ˆì‹œì§€ ì•Šì€ ë‚ ì„ ìŠ¤íŠ¸ë¦­ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ì„œ,
**so that** ì ˆì£¼ ë™ê¸°ë¶€ì—¬ë¥¼ ë°›ê³  ê¸°ë¡ì„ ì´ì–´ê°ˆ ìˆ˜ ìˆë‹¤.

---

## Acceptance Criteria

1. ìŠ¤íŠ¸ë¦­ ê³„ì‚° ë¡œì§ êµ¬í˜„ (ì—°ì† X ê¸°ë¡ ì¼ìˆ˜)
2. ëŒ€ì‹œë³´ë“œì— í˜„ì¬ ìŠ¤íŠ¸ë¦­ ìˆ«ì í‘œì‹œ ("ğŸ”¥ 7ì¼ ì—°ì†!")
3. ìŠ¤íŠ¸ë¦­ì— ë”°ë¥¸ ê²©ë ¤ ë©”ì‹œì§€ í‘œì‹œ
   - 0ì¼: "ì˜¤ëŠ˜ë¶€í„° ì‹œì‘í•´ë³¼ê¹Œìš”?"
   - 1-6ì¼: "ì¢‹ì€ ì‹œì‘ì´ì—ìš”! ê³„ì† ê°€ë´ìš”!"
   - 7ì¼+: "ëŒ€ë‹¨í•´ìš”! ì¼ì£¼ì¼ ë„˜ê²Œ ì„±ê³µí–ˆì–´ìš”!"
4. ìŠ¤íŠ¸ë¦­ì´ ê¹¨ì¡Œì„ ë•Œ ë¶€ë“œëŸ¬ìš´ ë©”ì‹œì§€ ("ê´œì°®ì•„ìš”, ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë¼ìš”!")
5. ìµœì¥ ìŠ¤íŠ¸ë¦­ ê¸°ë¡ ì €ì¥ ë° í‘œì‹œ
6. ì£¼ê°„ ë¯¸ë‹ˆ ìº˜ë¦°ë” ë¯¸ë¦¬ë³´ê¸° (ìµœê·¼ 7ì¼ O/X í‘œì‹œ)

---

## Tasks / Subtasks

- [x] **Task 1: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ** (AC: 5)
  - [x] `streaks` í…Œì´ë¸” - V1__init_schema.sqlì— ì´ë¯¸ ì¡´ì¬
    ```sql
    CREATE TABLE streaks (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
        current_streak INT NOT NULL DEFAULT 0,
        longest_streak INT NOT NULL DEFAULT 0,
        streak_start_date DATE,
        last_check_date DATE,
        updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX idx_streaks_user ON streaks(user_id);
    ```

- [x] **Task 2: JPA ì—”í‹°í‹° ë° Repository** (AC: 5)
  - [x] `Streak` ì—”í‹°í‹° ìƒì„± (`domain/entity/Streak.kt`)
  - [x] `StreakRepository` ì¸í„°í˜ì´ìŠ¤ ìƒì„±
    - [x] `findByUserId(userId: UUID): Streak?`

- [x] **Task 3: StreakService êµ¬í˜„** (AC: 1, 4, 5)
  - [x] `StreakService.kt` ìƒì„±
  - [x] `getOrCreateStreak(userId: UUID): Streak` - ìŠ¤íŠ¸ë¦­ ì¡°íšŒ/ìƒì„±
  - [x] `updateStreak(userId: UUID, checkIn: CheckIn)` - ì²´í¬ì¸ í›„ ìŠ¤íŠ¸ë¦­ ì—…ë°ì´íŠ¸
  - [x] ìŠ¤íŠ¸ë¦­ ê³„ì‚° ë¡œì§:
    - [x] is_sober = true â†’ í˜„ì¬ ìŠ¤íŠ¸ë¦­ +1
    - [x] is_sober = false â†’ í˜„ì¬ ìŠ¤íŠ¸ë¦­ 0ìœ¼ë¡œ ë¦¬ì…‹
    - [x] ìµœì¥ ìŠ¤íŠ¸ë¦­ ê°±ì‹  (current > longestë©´ ì—…ë°ì´íŠ¸)
    - [x] streak_start_date ê´€ë¦¬

- [x] **Task 4: CheckInServiceì™€ ì—°ë™** (AC: 1)
  - [x] `CheckInService.checkIn()` ìˆ˜ì •
  - [x] ì²´í¬ì¸ ì €ì¥ í›„ `StreakService.updateStreak()` í˜¸ì¶œ
  - [x] íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì²˜ë¦¬

- [x] **Task 5: ìŠ¤íŠ¸ë¦­ ë©”ì‹œì§€ ì‹œìŠ¤í…œ** (AC: 3, 4)
  - [x] `StreakMessages.kt` ìƒì„±
  - [x] ìŠ¤íŠ¸ë¦­ ë ˆë²¨ë³„ ë©”ì‹œì§€
  - [x] 0ì¼: "ì˜¤ëŠ˜ë¶€í„° ì‹œì‘í•´ë³¼ê¹Œìš”?"
  - [x] 1-2ì¼: "ì¢‹ì€ ì‹œì‘ì´ì—ìš”!"
  - [x] 3-6ì¼: "ì˜ í•˜ê³  ìˆì–´ìš”! ê³„ì† ê°€ë´ìš”!"
  - [x] 7-13ì¼: "ëŒ€ë‹¨í•´ìš”! ì¼ì£¼ì¼ ë„˜ê²Œ ì„±ê³µ!"
  - [x] 14-29ì¼: "2ì£¼ ì—°ì†! ë†€ë¼ì›Œìš”!"
  - [x] 30ì¼+: "í•œ ë‹¬ ì´ìƒ! ì •ë§ ëŒ€ë‹¨í•´ìš”!"
  - [x] ìŠ¤íŠ¸ë¦­ ê¹¨ì§: "ê´œì°®ì•„ìš”, ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë¼ìš”"

- [x] **Task 6: ìŠ¤íŠ¸ë¦­ í‘œì‹œ UI** (AC: 2, 3)
  - [x] `templates/fragments/streak-display.html` ìƒì„±
  - [x] ìŠ¤íŠ¸ë¦­ ìˆ«ì í¬ê²Œ í‘œì‹œ (ğŸ”¥ / ğŸ’§ ì•„ì´ì½˜)
  - [x] ìŠ¤íŠ¸ë¦­ ë©”ì‹œì§€ í‘œì‹œ
  - [x] ìµœì¥ ìŠ¤íŠ¸ë¦­ í‘œì‹œ ("ìµœê³  ê¸°ë¡: Nì¼")
  - [x] ìŠ¤íŠ¸ë¦­ì— ë”°ë¥¸ ì´ëª¨ì§€/ì•„ì´ì½˜ ë³€í™”

- [x] **Task 7: ì£¼ê°„ ë¯¸ë‹ˆ ìº˜ë¦°ë”** (AC: 6)
  - [x] `templates/fragments/weekly-preview.html` ìƒì„±
  - [x] ìµœê·¼ 7ì¼ ë‚ ì§œ í‘œì‹œ (ì›”, í™”, ìˆ˜...)
  - [x] ê° ë‚ ì§œë³„ O/X ì•„ì´ì½˜ í‘œì‹œ
    - [x] â­•: ì•ˆë§ˆì‹¬ (ì´ˆë¡)
    - [x] âŒ: ë§ˆì‹¬ (ì£¼í™©)
    - [x] Â·: ê¸°ë¡ ì—†ìŒ (ë¹ˆ ìƒíƒœ)
  - [x] ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° í‘œì‹œ (ring-2 ring-emerald-400)

- [x] **Task 8: ëŒ€ì‹œë³´ë“œ í†µí•©**
  - [x] `home.html` ìŠ¤íŠ¸ë¦­ ì˜ì—­ì— Fragment í†µí•©
  - [x] ì²´í¬ì¸ í›„ ìŠ¤íŠ¸ë¦­ ì˜ì—­ HTMX ì—…ë°ì´íŠ¸
  - [x] `hx-trigger="load, streakUpdated from:body"` ì´ë²¤íŠ¸ ì—°ë™

- [x] **Task 9: StreakController êµ¬í˜„**
  - [x] `StreakController.kt` ìƒì„±
  - [x] `GET /streak` - í˜„ì¬ ìŠ¤íŠ¸ë¦­ ì •ë³´ ì¡°íšŒ (HTMXìš©)
  - [x] `GET /streak/weekly` - ì£¼ê°„ ë¯¸ë‹ˆ ìº˜ë¦°ë” ë°ì´í„°

---

## Dev Notes

### í”„ë¡œì íŠ¸ êµ¬ì¡° (ì´ ìŠ¤í† ë¦¬ ê´€ë ¨)

```
src/main/kotlin/com/drinky/
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ StreakController.kt
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ entity/
â”‚       â””â”€â”€ Streak.kt
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ StreakRepository.kt
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ StreakService.kt
â”‚   â””â”€â”€ CheckInService.kt (ìˆ˜ì •)
â””â”€â”€ util/
    â””â”€â”€ StreakMessages.kt

src/main/resources/templates/
â””â”€â”€ fragments/
    â”œâ”€â”€ streak-display.html
    â””â”€â”€ weekly-preview.html
```

### Streak ì—”í‹°í‹°

```kotlin
@Entity
@Table(name = "streaks")
class Streak(
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    val id: UUID? = null,

    @Column(name = "user_id", nullable = false, unique = true)
    val userId: UUID,

    @Column(name = "current_streak", nullable = false)
    var currentStreak: Int = 0,

    @Column(name = "longest_streak", nullable = false)
    var longestStreak: Int = 0,

    @Column(name = "streak_start_date")
    var streakStartDate: LocalDate? = null,

    @Column(name = "last_check_date")
    var lastCheckDate: LocalDate? = null,

    @Column(name = "updated_at", nullable = false)
    var updatedAt: LocalDateTime = LocalDateTime.now()
)
```

### StreakService í•µì‹¬ ë¡œì§

```kotlin
@Service
@Transactional
class StreakService(
    private val streakRepository: StreakRepository
) {
    fun updateStreak(userId: UUID, checkIn: CheckIn) {
        val streak = getOrCreateStreak(userId)
        val today = checkIn.checkDate

        if (checkIn.isSober) {
            // ì—°ì† ì²´í¬ì¸ í™•ì¸
            val isConsecutive = streak.lastCheckDate?.plusDays(1) == today
                    || streak.lastCheckDate == today

            if (isConsecutive || streak.currentStreak == 0) {
                if (streak.lastCheckDate != today) {
                    streak.currentStreak++
                }
                if (streak.streakStartDate == null) {
                    streak.streakStartDate = today
                }
            } else {
                // ì—°ì† ëŠê¹€ í›„ ìƒˆë¡œ ì‹œì‘
                streak.currentStreak = 1
                streak.streakStartDate = today
            }

            // ìµœì¥ ìŠ¤íŠ¸ë¦­ ê°±ì‹ 
            if (streak.currentStreak > streak.longestStreak) {
                streak.longestStreak = streak.currentStreak
            }
        } else {
            // ìŠ¤íŠ¸ë¦­ ë¦¬ì…‹
            streak.currentStreak = 0
            streak.streakStartDate = null
        }

        streak.lastCheckDate = today
        streak.updatedAt = LocalDateTime.now()
        streakRepository.save(streak)
    }
}
```

### ìŠ¤íŠ¸ë¦­ í‘œì‹œ UI ì˜ˆì‹œ

```html
<div th:fragment="display" id="streak-area" class="text-center">
    <!-- ìŠ¤íŠ¸ë¦­ ìˆ«ì -->
    <div class="mb-4">
        <span class="text-5xl font-bold text-emerald-600">
            ğŸ”¥ <span th:text="${streak.currentStreak}">0</span>ì¼
        </span>
    </div>

    <!-- ë©”ì‹œì§€ -->
    <p class="text-gray-600 mb-4" th:text="${message}">
        ì˜¤ëŠ˜ë¶€í„° ì‹œì‘í•´ë³¼ê¹Œìš”?
    </p>

    <!-- ìµœì¥ ìŠ¤íŠ¸ë¦­ -->
    <p class="text-sm text-gray-400">
        ìµœê³  ê¸°ë¡: <span th:text="${streak.longestStreak}">0</span>ì¼
    </p>

    <!-- ì£¼ê°„ ë¯¸ë‹ˆ ìº˜ë¦°ë” -->
    <div th:replace="~{fragments/weekly-preview :: calendar}"></div>
</div>
```

### ì£¼ê°„ ë¯¸ë‹ˆ ìº˜ë¦°ë” ì˜ˆì‹œ

```html
<div th:fragment="calendar" class="mt-6">
    <div class="flex justify-center gap-2">
        <div th:each="day : ${weeklyData}" class="flex flex-col items-center">
            <span class="text-xs text-gray-400" th:text="${day.dayOfWeek}">ì›”</span>
            <div th:class="${day.isToday ? 'ring-2 ring-emerald-400' : ''}"
                 class="w-8 h-8 rounded-full flex items-center justify-center mt-1">
                <span th:if="${day.isSober}" class="text-emerald-500">â­•</span>
                <span th:if="${day.isSober == false}" class="text-gray-400">âŒ</span>
                <span th:if="${day.isSober == null}" class="text-gray-200">Â·</span>
            </div>
        </div>
    </div>
</div>
```

### ì²´í¬ì¸ í›„ ìŠ¤íŠ¸ë¦­ ì—…ë°ì´íŠ¸ (HTMX)

```html
<!-- CheckInControllerì—ì„œ ì²´í¬ì¸ ì„±ê³µ ì‹œ ì´ë²¤íŠ¸ ë°œìƒ -->
<div hx-trigger="load" hx-get="/streak" hx-target="#streak-area" hx-swap="innerHTML">
</div>

<!-- ë˜ëŠ” HX-Trigger í—¤ë” ì‚¬ìš© -->
<!-- Response Header: HX-Trigger: streakUpdated -->
```

---

## Testing

### ì´ ìŠ¤í† ë¦¬ì˜ í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­

| í…ŒìŠ¤íŠ¸ íŒŒì¼ | í…ŒìŠ¤íŠ¸ ë‚´ìš© |
|------------|------------|
| `StreakServiceTest.kt` | ìŠ¤íŠ¸ë¦­ ê³„ì‚° ë¡œì§, ì—°ì†/ë¹„ì—°ì† ì¼€ì´ìŠ¤ |
| `StreakControllerTest.kt` | ìŠ¤íŠ¸ë¦­ ì¡°íšŒ API í…ŒìŠ¤íŠ¸ |

### StreakServiceTest ì˜ˆì‹œ

```kotlin
class StreakServiceTest {

    @Test
    fun `ì—°ì† ê¸ˆì£¼ ì‹œ ìŠ¤íŠ¸ë¦­ ì¦ê°€`() {
        // given
        val userId = UUID.randomUUID()
        // Day 1: ê¸ˆì£¼
        streakService.updateStreak(userId, CheckIn(userId, LocalDate.now().minusDays(1), true))

        // when - Day 2: ê¸ˆì£¼
        streakService.updateStreak(userId, CheckIn(userId, LocalDate.now(), true))

        // then
        val streak = streakService.getOrCreateStreak(userId)
        assertThat(streak.currentStreak).isEqualTo(2)
    }

    @Test
    fun `ìŒì£¼ ì‹œ ìŠ¤íŠ¸ë¦­ ë¦¬ì…‹`() {
        // given - 3ì¼ ìŠ¤íŠ¸ë¦­
        val userId = UUID.randomUUID()
        // ... 3ì¼ ì—°ì† ê¸ˆì£¼ í›„

        // when - ìŒì£¼
        streakService.updateStreak(userId, CheckIn(userId, LocalDate.now(), false))

        // then
        val streak = streakService.getOrCreateStreak(userId)
        assertThat(streak.currentStreak).isEqualTo(0)
        assertThat(streak.longestStreak).isEqualTo(3) // ìµœì¥ ê¸°ë¡ ìœ ì§€
    }

    @Test
    fun `ìµœì¥ ìŠ¤íŠ¸ë¦­ ê°±ì‹ `() {
        // given - ìµœì¥ 5ì¼, í˜„ì¬ 5ì¼
        // when - 6ì¼ì§¸ ê¸ˆì£¼
        // then - ìµœì¥ ìŠ¤íŠ¸ë¦­ 6ìœ¼ë¡œ ê°±ì‹ 
    }
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 0.1 | ìŠ¤í† ë¦¬ ì´ˆì•ˆ ì‘ì„± | PO Sarah |
| 2026-02-05 | 0.2 | ìŠ¤í† ë¦¬ êµ¬í˜„ ì™„ë£Œ - ìŠ¤íŠ¸ë¦­ ê³„ì‚°, UI, ì£¼ê°„ ìº˜ë¦°ë” | Dev James |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- ë¹Œë“œ/í…ŒìŠ¤íŠ¸ í†µê³¼: 41ê°œ í…ŒìŠ¤íŠ¸ (StreakServiceTest 10ê°œ, StreakRepositoryTest 3ê°œ, StreakControllerTest 2ê°œ í¬í•¨)

### Completion Notes List
- Task 1: streaks í…Œì´ë¸”ì´ V1__init_schema.sqlì— ì´ë¯¸ ì¡´ì¬í•˜ì—¬ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶ˆí•„ìš”
- Task 2: Streak ì—”í‹°í‹° ë° StreakRepository ìƒì„± ì™„ë£Œ
- Task 3: StreakService êµ¬í˜„ - ì—°ì† ì²´í¬ì¸ ë¡œì§, ìŠ¤íŠ¸ë¦­ ë¦¬ì…‹, ìµœì¥ ê¸°ë¡ ê°±ì‹ 
- Task 4: CheckInServiceì— StreakService ì—°ë™ - ì²´í¬ì¸ ì‹œ ìë™ ìŠ¤íŠ¸ë¦­ ì—…ë°ì´íŠ¸
- Task 5: StreakMessages.kt - ìŠ¤íŠ¸ë¦­ ë ˆë²¨ë³„/ìƒí™©ë³„ ê²©ë ¤ ë©”ì‹œì§€
- Task 6: streak-display.html Fragment ìƒì„± - ìŠ¤íŠ¸ë¦­ ìˆ«ì, ë©”ì‹œì§€, ìµœì¥ ê¸°ë¡ í‘œì‹œ
- Task 7: weekly-preview.html Fragment ìƒì„± - ì£¼ê°„ ë¯¸ë‹ˆ ìº˜ë¦°ë” (ì›”~ì¼)
- Task 8: home.html HTMX í†µí•© - hx-trigger="load, streakUpdated from:body"
- Task 9: StreakController - GET /streak, GET /streak/weekly ì—”ë“œí¬ì¸íŠ¸
- CheckInControllerì— HX-Trigger: streakUpdated í—¤ë” ì¶”ê°€

### File List
**ì‹ ê·œ ìƒì„±:**
- `src/main/kotlin/com/drinky/domain/entity/Streak.kt`
- `src/main/kotlin/com/drinky/domain/dto/WeeklyDayData.kt`
- `src/main/kotlin/com/drinky/repository/StreakRepository.kt`
- `src/main/kotlin/com/drinky/service/StreakService.kt`
- `src/main/kotlin/com/drinky/controller/StreakController.kt`
- `src/main/kotlin/com/drinky/util/StreakMessages.kt`
- `src/main/resources/templates/fragments/streak-display.html`
- `src/main/resources/templates/fragments/weekly-preview.html`
- `src/test/kotlin/com/drinky/service/StreakServiceTest.kt`
- `src/test/kotlin/com/drinky/repository/StreakRepositoryTest.kt`
- `src/test/kotlin/com/drinky/controller/StreakControllerTest.kt`

**ìˆ˜ì •:**
- `src/main/kotlin/com/drinky/service/CheckInService.kt` - StreakService ì—°ë™
- `src/main/kotlin/com/drinky/controller/CheckInController.kt` - HX-Trigger í—¤ë” ì¶”ê°€
- `src/main/resources/templates/pages/home.html` - ìŠ¤íŠ¸ë¦­ ì˜ì—­ HTMX í†µí•©
- `src/test/kotlin/com/drinky/service/CheckInServiceTest.kt` - StreakService mock ì¶”ê°€

---

## QA Results
*(QA ì—ì´ì „íŠ¸ì˜ ë¦¬ë·° ê²°ê³¼)*
